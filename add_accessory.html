<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¬Ø¯ÙŠØ¯ â€” Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠ</title>

  <!-- Ù†ÙØ³ Ø®Ø·ÙˆØ·/Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #2c3e50; border-color: #2c3e50; }
    .btn-primary:hover { background-color: #1a252f; border-color: #1a252f; }
  </style>
</head>
<body>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand">Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠ</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <!-- Navigation will be populated by navigation.js -->
        </ul>
      </div>
    </div>
  </nav>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© (Ù†ÙØ³ ØªØ®Ø·ÙŠØ·Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ) -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¬Ø¯ÙŠØ¯</h2>
    </div>

    <div class="row">
      <div class="col-md-8 mx-auto">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-box"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±</h5>
          </div>
          <div class="card-body">
            <!-- ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·: Ù„Ø§ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø®Ø§Ø¯Ù… -->
            <form action="#" onsubmit="return false;">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="name" class="form-label">Ø§Ø³Ù… Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± *</label>
                    <input type="text" class="form-control" id="name" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="category" class="form-label">Ø§Ù„ÙØ¦Ø© *</label>
                    <div class="input-group">
                      <select class="form-select" id="category" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                        <!-- Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ø§Ù„Ø¢Ù†Ø› Ø³ØªÙ…Ù„Ø¤Ù‡Ø§ Ø¨Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ù„Ø§Ø­Ù‚Ù‹Ø§ -->
                      </select>
                      <button class="btn btn-outline-success" type="button" onclick="addCategory()">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                      </button>
                      <button class="btn btn-outline-danger" type="button" onclick="deleteCategory()">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="description" class="form-label">Ø§Ù„ÙˆØµÙ</label>
                <textarea class="form-control" id="description" rows="3"></textarea>
              </div>

              <div class="row">
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="purchase_price" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù…Ø¹ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©) *</label>
                    <input type="text" class="form-control arabic-number-field" id="purchase_price" required>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="selling_price" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù…Ø¹ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©) *</label>
                    <input type="text" class="form-control arabic-number-field" id="selling_price" required>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <label for="quantity" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
                    <input type="text" class="form-control arabic-number-field" id="quantity" value="1" required>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="supplier" class="form-label">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                    <input type="text" class="form-control" id="supplier">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="barcode" class="form-label">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="barcode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯">
                      <button class="btn btn-outline-primary" type="button" onclick="generateBarcode()">
                        <i class="fas fa-barcode"></i> ØªÙˆÙ„ÙŠØ¯
                      </button>
                    </div>
                    <small class="form-text text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø®ØµØµ Ø£Ùˆ ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ±ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="notes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea class="form-control" id="notes" rows="3"></textarea>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-success btn-lg">
                  <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±
                </button>
                <button type="button" class="btn btn-primary btn-lg" id="printBarcodeBtn" onclick="printBarcode()" style="display: none;">
                  <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                </button>
              </div>
            </form>
            <!-- /form -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù†ÙØ³Ù‡Ø§ -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Firebase Configuration -->
  <script type="module" src="js/firebase-config-cdn.js"></script>
  <script type="module" src="js/firebase-database-cdn.js"></script>
  <script type="module" src="js/firebase-storage-manager.js"></script>

  <!-- Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    const VAT_RATE = 0.15; // 15% Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª Ù…Ù† Firebase
    async function loadCategories() {
      const categorySelect = document.getElementById('category');
      categorySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>';
      
      try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø§Øª Ù…Ù† Firebase
        if (window.storage && window.storage.isFirebaseAvailable) {
          const categories = await window.storage.getAccessoryCategories();
          if (categories && categories.length > 0) {
            categories.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat.name;
              option.textContent = cat.arabic_name;
              categorySelect.appendChild(option);
            });
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ÙØ¦Ø§Øª Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Firebase');
            return;
          }
        }
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙƒØ¨Ø¯ÙŠÙ„
        const defaultCategories = [
          { name: 'case', arabic_name: 'Ø£ØºÙ„ÙØ©' },
          { name: 'charger', arabic_name: 'Ø´ÙˆØ§Ø­Ù†' },
          { name: 'screen_protector', arabic_name: 'Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø©' },
          { name: 'cable', arabic_name: 'ÙƒØ§Ø¨Ù„Ø§Øª' },
          { name: 'headphone', arabic_name: 'Ø³Ù…Ø§Ø¹Ø§Øª' },
          { name: 'other', arabic_name: 'Ø£Ø®Ø±Ù‰' }
        ];
        
        defaultCategories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.name;
          option.textContent = cat.arabic_name;
          categorySelect.appendChild(option);
        });
        
        console.log('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª:', error);
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© - Ø·Ø±ÙŠÙ‚Ø© Ù…Ø­Ø³Ù†Ø©
    function convertArabicToEnglishNumbers(str) {
      if (!str) return '';
      
      // Ø®Ø±ÙŠØ·Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
      const arabicToEnglish = {
        'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
        'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9'
      };
      
      return str.toString().replace(/[Ù -Ù©]/g, function(match) {
        return arabicToEnglish[match] || match;
      });
    }

    // ØªØ­ÙˆÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ù‚Ù„ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø±Ù‚Ù… ØµØ­ÙŠØ­
    function parseArabicNumber(value) {
      if (!value || value.trim() === '') return 0;
      
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
      const convertedValue = convertArabicToEnglishNumbers(value.toString());
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„ Ù„Ø±Ù‚Ù…
      const number = parseFloat(convertedValue);
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù‚Ù…
      if (isNaN(number)) {
        console.log('ÙØ´Ù„ ÙÙŠ ØªØ­ÙˆÙŠÙ„:', value, 'â†’', convertedValue, 'â†’', number);
        return 0;
      }
      
      console.log('ØªØ­ÙˆÙŠÙ„ Ù†Ø§Ø¬Ø­:', value, 'â†’', convertedValue, 'â†’', number);
      return number;
    }


    async function addCategory() {
      const name = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
      if (!name || !name.trim()) return;
      
      const categoryName = name.trim();

      try {
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø¥Ù„Ù‰ Firebase
        if (window.storage && window.storage.isFirebaseAvailable) {
          const categoryData = {
            name: categoryName,
            arabic_name: categoryName,
            description: `ÙØ¦Ø© ${categoryName}`
          };
          
          const categoryId = await window.storage.addAccessoryCategory(categoryData);
          if (categoryId) {
            console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø¥Ù„Ù‰ Firebase:', categoryId);
          }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        const sel = document.getElementById('category');
        const opt = document.createElement('option');
        opt.value = categoryName;
        opt.textContent = categoryName;
        sel.appendChild(opt);
        sel.value = categoryName;
        
        showAlert('success', `ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© "${categoryName}" Ø¨Ù†Ø¬Ø§Ø­!`);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await loadCategories();
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©');
      }
    }

    async function deleteCategory() {
      const sel = document.getElementById('category');
      if (!sel.value) { 
        showAlert('warning', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ø£ÙˆÙ„Ø§Ù‹');
        return; 
      }
      
      const selectedOption = sel.options[sel.selectedIndex];
      const categoryText = selectedOption.textContent;
      const categoryValue = sel.value;
      
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙØ¦Ø© "${categoryText}"ØŸ`)) return;
      
      try {
        // Ø­Ø°Ù Ù…Ù† Firebase
        if (window.storage && window.storage.isFirebaseAvailable) {
          const success = await window.storage.deleteAccessoryCategory(categoryText);
          if (success) {
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ù…Ù† Firebase:', categoryText);
          }
        }
        
        // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        selectedOption.remove();
        sel.value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        
        showAlert('success', `ØªÙ… Ø­Ø°Ù ÙØ¦Ø© "${categoryText}" Ø¨Ù†Ø¬Ø§Ø­!`);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await loadCategories();
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©');
      }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function checkLogin() {
      const currentUser = localStorage.getItem('current_user');
      if (!currentUser) {
        alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ±ÙŠØ¯ Ù„Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±
    function generateBarcode() {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø®ØµØµ Ø£ÙˆÙ„Ø§Ù‹
      const currentBarcode = document.getElementById('barcode').value.trim();
      if (currentBarcode) {
        if (confirm(`ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø®ØµØµ: "${currentBarcode}". Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ØŸ`)) {
          // Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
        } else {
          return; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        }
      }
      
      const today = new Date();
      const dateStr = today.getFullYear().toString() + 
                     (today.getMonth() + 1).toString().padStart(2, '0') + 
                     today.getDate().toString().padStart(2, '0');
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®
      let lastSerial = localStorage.getItem(`lastAccessorySerial_${dateStr}`) || '0';
      const nextSerial = (parseInt(lastSerial) + 1).toString().padStart(4, '0');
      
      // Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      localStorage.setItem(`lastAccessorySerial_${dateStr}`, nextSerial);
      
      const barcode = `ACC-${dateStr}-${nextSerial}`;
      document.getElementById('barcode').value = barcode;
      
      showAlert('success', `ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯: ${barcode}`);
    }

    // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    function printBarcode() {
      const barcode = document.getElementById('barcode').value.trim();
      if (!barcode) {
        showAlert('warning', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      // ÙØªØ­ ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      const printUrl = `print_accessory_barcode.html?barcode=${encodeURIComponent(barcode)}`;
      window.open(printUrl, '_blank');
    }

    // Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯


    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - Ø·Ø±ÙŠÙ‚Ø© Ù…Ø­Ø³Ù†Ø©
    function setupArabicNumberSupport() {
      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ø§Ø³ arabic-number-field
      const numberFields = document.querySelectorAll('.arabic-number-field');
      
      numberFields.forEach(field => {
        field.addEventListener('input', function() {
          const cursorPosition = this.selectionStart;
          const originalValue = this.value;
          const convertedValue = convertArabicToEnglishNumbers(originalValue);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¥Ø°Ø§ ØªØºÙŠØ±Øª
          if (convertedValue !== originalValue) {
            this.value = convertedValue;
            this.setSelectionRange(cursorPosition, cursorPosition);
            
            // Ø±Ø³Ø§Ù„Ø© ÙÙŠ Console Ù„Ù„ØªØ£ÙƒØ¯
            console.log(`ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ø­Ù‚Ù„ ${this.id}: "${originalValue}" â†’ "${convertedValue}"`);
          }
        });
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ²
        field.addEventListener('focus', function() {
          this.style.borderColor = '#007bff';
          this.style.boxShadow = '0 0 0 0.2rem rgba(0,123,255,.25)';
        });
        
        field.addEventListener('blur', function() {
          this.style.borderColor = '';
          this.style.boxShadow = '';
        });
      });
      
      console.log(`ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù€ ${numberFields.length} Ø­Ù‚Ù„`);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ÙÙŠ Firebase
    async function saveAccessoryToFirebase() {
      try {
        // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        const purchasePriceRaw = document.getElementById('purchase_price').value;
        const sellingPriceRaw = document.getElementById('selling_price').value;
        const quantityRaw = document.getElementById('quantity').value;
        
        const accessoryData = {
          name: document.getElementById('name').value.trim(),
          arabic_name: document.getElementById('name').value.trim(), // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
          category: document.getElementById('category').value,
          barcode: document.getElementById('barcode').value.trim(),
          barcode_id: document.getElementById('barcode').value.trim().replace(/[^a-zA-Z0-9]/g, ''), // Ù„Ù„Ø¨Ø­Ø« Ø¨Ø¯ÙˆÙ† Ø±Ù…ÙˆØ²
          quantity: parseInt(convertArabicToEnglishNumbers(quantityRaw)) || 0,
          quantity_in_stock: parseInt(convertArabicToEnglishNumbers(quantityRaw)) || 0, // Ø¥Ø¶Ø§ÙØ© quantity_in_stock
          purchase_price: parseArabicNumber(purchasePriceRaw),
          selling_price: parseArabicNumber(sellingPriceRaw),
          description: document.getElementById('description').value.trim(),
          supplier: document.getElementById('supplier').value.trim(),
          notes: document.getElementById('notes').value.trim(),
          date_added: new Date().toISOString()
        };

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if (!accessoryData.name) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
          return false;
        }

        if (!accessoryData.category) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø©');
          return false;
        }

        if (!purchasePriceRaw || accessoryData.purchase_price <= 0) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: Ù¡Ù¢Ù£.Ù¤Ù¥ Ø£Ùˆ 123.45)');
          return false;
        }

        if (!sellingPriceRaw || accessoryData.selling_price <= 0) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹ ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: Ù¢Ù Ù .Ù§Ù¥ Ø£Ùˆ 200.75)');
          return false;
        }

        if (!quantityRaw || accessoryData.quantity < 0) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© (Ù…Ø«Ø§Ù„: Ù¡Ù  Ø£Ùˆ 10)');
          return false;
        }

        if (!accessoryData.barcode) {
          showAlert('warning', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø± Ø£Ùˆ ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ±ÙŠØ¯');
          return false;
        }

        // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­ÙØ¸Ù‡Ø§ Ù„Ù„ØªØ´Ø®ÙŠØµ
        console.log('ğŸ“¦ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­ÙØ¸Ù‡Ø§:', accessoryData);

        // Ø­ÙØ¸ ÙÙŠ Firebase
        if (window.storage && window.storage.isFirebaseAvailable) {
          console.log('ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ÙÙŠ Firebase...');
          const accessoryId = await window.storage.addAccessory(accessoryData);
          if (accessoryId) {
            console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­! ID:', accessoryId);
            console.log('ğŸ“‚ Ø§Ù„ÙØ¦Ø©:', accessoryData.category);
            console.log('ğŸ·ï¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', accessoryData.barcode);
            showAlert('success', `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± "${accessoryData.name}" Ø¨Ù†Ø¬Ø§Ø­!`);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
            document.getElementById('printBarcodeBtn').style.display = 'inline-block';
            
            return true;
          } else {
            console.log('âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ÙÙŠ Firebase - Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ ID');
            showAlert('danger', 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            return false;
          }
        } else {
          console.log('ğŸ’¾ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø­ÙØ¸ ÙÙŠ localStorage...');
          // Ø­ÙØ¸ ÙÙŠ LocalStorage ÙƒØ¨Ø¯ÙŠÙ„
          const accessories = JSON.parse(localStorage.getItem('accessories') || '[]');
          accessoryData.id = Date.now().toString();
          accessories.push(accessoryData);
          localStorage.setItem('accessories', JSON.stringify(accessories));
          console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ÙÙŠ localStorage');
          console.log('ğŸ·ï¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', accessoryData.barcode);
          showAlert('success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­! (Ù…Ø­Ù„ÙŠ)');
          
          // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
          document.getElementById('printBarcodeBtn').style.display = 'inline-block';
          
          return true;
        }
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        return false;
      }
    }

    // Check user role and update navigation
    function updateNavigationForUser() {
      const currentUser = localStorage.getItem('current_user');
      if (currentUser) {
        try {
          const userData = JSON.parse(currentUser);
          const navbar = document.querySelector('.navbar-nav.me-auto');
          
          if (userData.role === 'user') {
            // Show simplified navigation for limited users
            navbar.innerHTML = `
              <li class="nav-item"><a class="nav-link" href="limited_dashboard.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
              <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            `;
          }
          // Admin users keep the full navigation (default)
        } catch (error) {
          console.error('Error parsing user data:', error);
        }
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', async function() {
      // Update navigation based on user role
      updateNavigationForUser();
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
      if (!checkLogin()) return;

      // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Firebase
      await new Promise(resolve => setTimeout(resolve, 1000));

      await loadCategories();
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
      setupArabicNumberSupport();
      
      // Ø±Ø¨Ø· Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸
      const form = document.querySelector('form');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const success = await saveAccessoryToFirebase();
          if (success) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            form.reset();
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª
            await loadCategories();
          }
        });
      }
      
      // ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„
      document.getElementById('name').focus();
      
      // ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      generateBarcode();
    });
  </script>

  <!-- Navigation Script -->
  <script src="js/navigation.js"></script>
  <script>
    // Initialize navigation when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initNavigation('add_accessory');
    });
  </script>
</body>
</html>
