<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø© â€” Ù…Ù‡Ù†Ø¯ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</title>

  <!-- Ù†ÙØ³ Ø§Ù„Ø®Ø·/Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ù„Ø¨ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #2c3e50; border-color: #2c3e50; }
    .btn-primary:hover { background-color: #1a252f; border-color: #1a252f; }
  </style>
</head>
<body>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand">Ù…Ù‡Ù†Ø¯ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <!-- Navigation will be populated by navigation.js -->
        </ul>
      </div>
    </div>
  </nav>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-shopping-cart"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <a href="dashboard.html" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </a>
    </div>

    <div class="row">
      <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h5>
          </div>
          <div class="card-body">
            <form id="customerForm" action="#" onsubmit="return false;">
              <div class="mb-3">
                <label for="customer_name" class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <input type="text" class="form-control" id="customer_name" name="customer_name">
              </div>
              <div class="mb-3">
                <label for="customer_phone" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="tel" class="form-control arabic-number-field" id="customer_phone" name="customer_phone">
              </div>
              <div class="mb-3">
                <label for="customer_email" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" class="form-control" id="customer_email" name="customer_email">
              </div>
              <div class="mb-3">
                <label for="customer_address" class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <textarea class="form-control" id="customer_address" name="customer_address" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label for="payment_method" class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select class="form-select" id="payment_method" name="payment_method">
                  <option value="Ù†Ù‚Ø¯ÙŠ">Ù†Ù‚Ø¯ÙŠ</option>
                  <option value="Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                  <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                  <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
                  <option value="ØªØ§Ø¨ÙŠ">ØªØ§Ø¨ÙŠ</option>
                  <option value="ØªÙ…Ø§Ø±Ø§">ØªÙ…Ø§Ø±Ø§</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="notes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-box"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h5>
          </div>
          <div class="card-body">
            <!-- Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
            <div class="row mb-3">
              <div class="col-md-12">
                <label for="barcode_search" class="form-label">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <div class="input-group">
                  <input type="text" class="form-control arabic-number-field" id="barcode_search" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹" onkeypress="if(event.key==='Enter') searchByBarcode()">
                  <button class="btn btn-outline-primary" type="button" onclick="searchByBarcode()">
                    <i class="fas fa-search"></i> Ø¨Ø­Ø«
                  </button>
                </div>
                <div id="barcode_search_result" class="mt-2" style="display: none;"></div>
              </div>
            </div>

            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ÙƒÙ…ÙŠØ© -->
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="product_type" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬</label>
                <select class="form-select" id="product_type" onchange="loadProducts()">
                  <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬</option>
                  <option value="phone">Ù‡Ø§ØªÙ</option>
                  <option value="accessory">Ø¥ÙƒØ³Ø³ÙˆØ§Ø±</option>
                  <option value="charger">Ø´Ø§Ø­Ù†</option>
                  <option value="case">ØºÙ„Ø§Ù</option>
                  <option value="screen_protector">Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø©</option>
                  <option value="other">Ø£Ø®Ø±Ù‰</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="product_select" class="form-label">Ø§Ù„Ù…Ù†ØªØ¬</label>
                <select class="form-select" id="product_select" onchange="updateProductInfo()">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="quantity" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                <input type="text" class="form-control arabic-number-field" id="quantity" value="1" onchange="updateTotalPrice()">
              </div>
            </div>

            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ -->
            <div id="product_details" class="mb-3" style="display: none;">
              <div class="card bg-light">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</strong> <span id="selected_product_name">-</span></p>
                      <p><strong>Ø§Ù„ÙˆØµÙ:</strong> <span id="selected_product_description">-</span></p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> <span id="selected_product_price">-</span> Ø±ÙŠØ§Ù„</p>
                      <p><strong>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> <span id="total_price" class="text-success fw-bold">-</span> Ø±ÙŠØ§Ù„</p>
                    </div>
                  </div>
                  <button type="button" class="btn btn-primary" onclick="addToCart()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
                  </button>
                </div>
              </div>
            </div>

            <!-- Ø§Ù„Ø³Ù„Ø© -->
            <div class="card">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-shopping-cart"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h6>
              </div>
              <div class="card-body">
                <div id="cart_items">
                  <p class="text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„Ø©</p>
                </div>

                <!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
                <div id="cart_summary" style="display: none;">
                  <hr>
                  <div class="row">
                    <div class="col-md-6">
                      <h5>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="cart_total" class="text-success fw-bold">0.00</span> Ø±ÙŠØ§Ù„</h5>

                      <!-- Ø§Ù„Ø¶Ù…Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
                      <div class="mt-3">
                        <label for="warranty_input" class="form-label">Ø§Ù„Ø¶Ù…Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <div class="input-group">
                          <input list="warranty_options" id="warranty_input" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ø¶Ù…Ø§Ù†">
                          <datalist id="warranty_options"></datalist>
                          <button class="btn btn-outline-secondary" type="button" onclick="addWarrantyOption()">Ø­ÙØ¸ ÙƒØ®ÙŠØ§Ø±</button>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6 text-end">
                      <button type="button" class="btn btn-success btn-lg" onclick="completeSale()" id="complete_sale_btn" disabled>
                        <i class="fas fa-check"></i> Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹
                      </button>
                    </div>
                  </div>
                </div>
                <!-- /Ø§Ù„Ù…Ù„Ø®Øµ -->
              </div>
            </div>

          </div>
        </div>
      </div>
      <!-- /Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª JS Ù†ÙØ³Ù‡Ø§ -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Firebase Configuration -->
  <script type="module" src="js/firebase-config-cdn.js"></script>
  <script type="module" src="js/firebase-database-cdn.js"></script>
  <script type="module" src="js/firebase-storage-manager.js"></script>
  
  <!-- Arabic Numbers Support -->
  <script src="js/arabic-numbers.js"></script>

  <!-- Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø· (Ø¨Ø¯Ù„ Ù…ØªØºÙŠØ±Ø§Øª Jinja ÙˆØ¨Ø¯Ù„ fetch Ù„Ù„Ø®Ø§Ø¯Ù…) -->
  <script>
    // ====== Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø© ======
    let phones = [];
    let accessories = [];
    let accessoryCategories = [];
    let sales = [];
    let cart = [];

    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ØªÙˆÙ‚Ø¹ Ø£Ù† window.storage ÙŠÙˆÙÙ‘Ø± Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Firebase Ù…ØªØ§Ø­Ø©:
    // getPhones(), getAccessories(), getAccessoryCategories(), getSales()
    // Ø¥Ø°Ø§ Ù…Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©ØŒ Ø¨ÙŠØµÙŠØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† LocalStorage.
  
    // Check user role and update navigation
    function updateNavigationForUser() {
      const currentUser = localStorage.getItem('current_user');
      if (currentUser) {
        try {
          const userData = JSON.parse(currentUser);
          const navbar = document.querySelector('.navbar-nav.me-auto');
          
          if (userData.role === 'user') {
            // Show simplified navigation for limited users
            navbar.innerHTML = `
              <li class="nav-item"><a class="nav-link" href="limited_dashboard.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
              <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            `;
          }
          // Admin users keep the full navigation (default)
        } catch (error) {
          console.error('Error parsing user data:', error);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Update navigation based on user role
      updateNavigationForUser();
      
      await new Promise(r => setTimeout(r, 400)); // Ù…Ù‡Ù„Ø© Ù‚ØµÙŠØ±Ø© Ù„Ø¶Ù…Ø§Ù† ØªÙ‡ÙŠØ¦Ø© window.storage
      if (window.storage && window.storage.isFirebaseAvailable) {
        console.log('âœ… Firebase Ù…ØªØ§Ø­ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');
        await loadDataFromFirebase();
      } else {
        console.log('ğŸ’¾ Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage ÙƒØ¨Ø¯ÙŠÙ„');
        await loadDataFromLocalStorage();
      }
      updateProductTypeDropdown();
      setupArabicNumberSupport();
      loadWarrantyOptions();
      loadProducts(); // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
    });
  
    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ======
    async function loadDataFromFirebase() {
      try {
        const [p, a, c, s] = await Promise.all([
          window.storage.getPhones?.() ?? [],
          window.storage.getAccessories?.() ?? [],
          window.storage.getAccessoryCategories?.() ?? [],
          window.storage.getSales?.() ?? []
        ]);
        phones = Array.isArray(p) ? p : [];
        accessories = Array.isArray(a) ? a : [];
        accessoryCategories = Array.isArray(c) ? c : [];
        sales = Array.isArray(s) ? s : [];
        console.log('ğŸ“¥ Firebase:', { phones: phones.length, accessories: accessories.length, categories: accessoryCategories.length, sales: sales.length });
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Firebase:', err);
        await loadDataFromLocalStorage();
      }
    }
  
    async function loadDataFromLocalStorage() {
      try {
        phones = JSON.parse(localStorage.getItem('phones') || '[]');
        accessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        accessoryCategories = JSON.parse(localStorage.getItem('accessory_categories') || '[]');
        sales = JSON.parse(localStorage.getItem('sales') || '[]');
        console.log('ğŸ“¦ localStorage:', { phones: phones.length, accessories: accessories.length, categories: accessoryCategories.length, sales: sales.length });
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ localStorage:', err);
        phones = []; accessories = []; accessoryCategories = []; sales = [];
      }
    }
  
    // ====== Ø¨ÙŠØ¹ Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ======
    function isPhoneSold(phoneId) {
      if (!sales || sales.length === 0) return false;
      const effectiveSales = sales.filter(s => s && s.returned !== true && s.status !== 'Ù…Ø³ØªØ±Ø¬Ø¹Ø©');
      return effectiveSales.some(sale =>
        Array.isArray(sale.items) &&
        sale.items.some(item => item.type === 'phone' && (item.id === phoneId || item.phone_id === phoneId))
      );
    }
  
    // ====== ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Firebase ======
    function updateProductTypeDropdown() {
      const productTypeSelect = document.getElementById('product_type');
      productTypeSelect.innerHTML = '';
  
      // Ø®ÙŠØ§Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ
      const base = document.createElement('option');
      base.value = '';
      base.textContent = 'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬';
      productTypeSelect.appendChild(base);
  
      // Ø®ÙŠØ§Ø± Ù‡Ø§ØªÙ (Ø«Ø§Ø¨Øª)
      const phoneOpt = document.createElement('option');
      phoneOpt.value = 'phone';
      phoneOpt.textContent = 'Ù‡Ø§ØªÙ';
      productTypeSelect.appendChild(phoneOpt);
  
      // ÙØ¦Ø§Øª Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© accessory_categories ÙÙŠ Firebase
      if (Array.isArray(accessoryCategories) && accessoryCategories.length > 0) {
        accessoryCategories.forEach(cat => {
          if (!cat?.name) return;
          const opt = document.createElement('option');
          opt.value = cat.name;         // Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡ÙŠ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©
          opt.textContent = cat.name;   // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©
          productTypeSelect.appendChild(opt);
        });
      } else {
        const noCat = document.createElement('option');
        noCat.value = '';
        noCat.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª â€” Ø£Ø¶Ù ÙØ¦Ø§Øª Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª';
        noCat.disabled = true;
        productTypeSelect.appendChild(noCat);
      }
  
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬:', productTypeSelect.options.length, 'Ø®ÙŠØ§Ø±');
    }
  
    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø± ======
    function loadProducts() {
      const productType = document.getElementById('product_type').value;
      const productSelect = document.getElementById('product_select');

      productSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>';
      document.getElementById('product_details').style.display = 'none';
  
      if (!productType) return;

      if (productType === 'phone') {
        // Ù‡ÙˆØ§ØªÙ ØºÙŠØ± Ù…Ø¨Ø§Ø¹Ø©
        const availablePhones = (phones || []).filter(ph => {
          const pid = ph.id || ph.phone_number;
          return pid && !isPhoneSold(pid);
        });
  
        if (availablePhones.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‡ÙˆØ§ØªÙ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹';
          opt.disabled = true;
          productSelect.appendChild(opt);
          return;
        }
  
        availablePhones.forEach(ph => {
          const opt = document.createElement('option');
          opt.value = ph.id || ph.phone_number; // Ø§Ù„Ù…Ø¹Ø±Ù‘Ù
          const manufacturer = ph.manufacturer || ph.brand || '';
          const model = ph.model || '';
          const barcode = ph.phone_number || ph.serial_number || '';
          const price = Number(ph.selling_price) || 0;
          const purchase = Number(ph.purchase_price) || 0;
  
          opt.textContent = `${manufacturer} ${model} â€” Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}`;
          opt.setAttribute('data-price', String(price));
          opt.setAttribute('data-purchase-price', String(purchase));
          opt.setAttribute('data-name', `${manufacturer} ${model}`.trim());
          opt.setAttribute('data-description', ph.description || '');
          opt.setAttribute('data-barcode', barcode);
          productSelect.appendChild(opt);
        });
      } else {
        // Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø¨Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© (Ù…Ù† accessories)
        const availableAccessories = (accessories || []).filter(acc => {
          const stock = Number(acc.quantity_in_stock ?? acc.quantity ?? 0);
          return acc?.category === productType && stock > 0;
        });
  
        if (availableAccessories.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©';
          opt.disabled = true;
          productSelect.appendChild(opt);
          return;
        }
  
        availableAccessories.forEach(acc => {
          const opt = document.createElement('option');
          opt.value = acc.id || acc.sku || '';
          const stock = Number(acc.quantity_in_stock ?? acc.quantity ?? 0);
          const price = Number(acc.selling_price ?? acc.price ?? 0);
          const purchase = Number(acc.purchase_price ?? 0);
          const displayName = (acc.arabic_name && acc.arabic_name !== acc.name) ? acc.arabic_name : (acc.name || '');
  
          opt.textContent = `${displayName} (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${stock})`;
          opt.setAttribute('data-price', String(price));
          opt.setAttribute('data-purchase-price', String(purchase));
          opt.setAttribute('data-name', displayName);
          opt.setAttribute('data-description', acc.description || '');
          opt.setAttribute('data-stock', String(stock));
          // Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ø§Ø­Ù‚Ø§Ù‹
          opt.setAttribute('data-id', opt.value);
          productSelect.appendChild(opt);
        });
      }
    }
  
    // ====== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø®ØªØ§Ø± ======
    function updateProductInfo() {
      const productSelect = document.getElementById('product_select');
      const selectedOption = productSelect.options[productSelect.selectedIndex];

      if (selectedOption && selectedOption.value) {
        document.getElementById('selected_product_name').textContent = selectedOption.getAttribute('data-name') || '-';
        document.getElementById('selected_product_description').textContent = selectedOption.getAttribute('data-description') || '-';
        document.getElementById('selected_product_price').textContent = selectedOption.getAttribute('data-price') || '0';
        updateTotalPrice();
        document.getElementById('product_details').style.display = 'block';
      } else {
        document.getElementById('product_details').style.display = 'none';
      }
    }

    function updateTotalPrice() {
      const price = parseFloat(document.getElementById('selected_product_price').textContent) || 0;
      const quantity = parseArabicNumber(document.getElementById('quantity').value) || 1;
      document.getElementById('total_price').textContent = (price * quantity).toFixed(2);
    }

    // ====== Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ======
    function convertArabicToEnglishNumbers(str) {
      if (!str) return '';
      const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
      return str.toString().replace(/[Ù -Ù©]/g, m => map[m] ?? m);
    }
    function convertEnglishToArabicNumbers(str) {
      if (!str) return '';
      const map = {'0':'Ù ','1':'Ù¡','2':'Ù¢','3':'Ù£','4':'Ù¤','5':'Ù¥','6':'Ù¦','7':'Ù§','8':'Ù¨','9':'Ù©'};
      return str.toString().replace(/[0-9]/g, m => map[m] ?? m);
    }
    function parseArabicNumber(value) {
      if (!value || value.trim() === '') return 0;
      const converted = convertArabicToEnglishNumbers(value.toString());
      const num = parseFloat(converted);
      return isNaN(num) ? 0 : num;
    }
    function setupArabicNumberSupport() {
      document.querySelectorAll('.arabic-number-field').forEach(field => {
        field.addEventListener('input', function() {
          const pos = this.selectionStart;
          const cv = convertArabicToEnglishNumbers(this.value);
          if (cv !== this.value) {
            this.value = cv;
            this.setSelectionRange(pos, pos);
          }
        });
      });
    }
  
    // ====== Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ======
    function addToCart() {
      const productType = document.getElementById('product_type').value;
      const productSelect = document.getElementById('product_select');
      const quantity = parseArabicNumber(document.getElementById('quantity').value) || 1;

      if (!productType || !productSelect.value) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ù…Ù†ØªØ¬');
        return;
      }

      const opt = productSelect.options[productSelect.selectedIndex];
  
      // ØªØ­Ù‚Ù‚ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª
      if (productType !== 'phone') {
        const availableStock = parseInt(opt.getAttribute('data-stock')) || 0;
        if (availableStock < quantity) {
          alert(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${quantity}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (${availableStock})`);
          return;
        }
      }
  
      const unitPrice = parseFloat(opt.getAttribute('data-price')) || 0;
      const purchasePrice = parseFloat(opt.getAttribute('data-purchase-price') || '0') || 0;
      const profit = unitPrice - purchasePrice;
      
      // Get battery level, condition, and serial number for phones
      let batteryLevel = null;
      let phoneCondition = null;
      let serialNumber = '';
      if (productType === 'phone') {
        const phoneId = productSelect.value;
        const phone = phones.find(p => (p.id || p.phone_number) === phoneId);
        if (phone) {
          batteryLevel = phone.battery_level || null;
          phoneCondition = phone.condition || phone.phone_type || 'new';
          serialNumber = phone.serial_number || '';
        }
      }
  
      const product = {
        id: productSelect.value,
        type: productType,
        name: opt.getAttribute('data-name') || '',
        description: opt.getAttribute('data-description') || '',
        serial_number: serialNumber,
        barcode: opt.getAttribute('data-barcode') || '',
        unitPrice,
        purchasePrice,
        profit,
        quantity,
        totalPrice: unitPrice * quantity,
        totalProfit: profit * quantity,
        battery_level: batteryLevel,
        condition: phoneCondition
      };

      cart.push(product);
      updateCartDisplay();

      // reset
      document.getElementById('product_type').value = '';
      document.getElementById('product_select').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>';
      document.getElementById('quantity').value = '1';
      document.getElementById('product_details').style.display = 'none';
    }

    // ====== Ø¹Ø±Ø¶ ÙˆØªÙ„Ø®ÙŠØµ Ø§Ù„Ø³Ù„Ø© ======
    function updateCartDisplay() {
      const cartItems = document.getElementById('cart_items');
      const cartSummary = document.getElementById('cart_summary');

      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø³Ù„Ø©</p>';
        cartSummary.style.display = 'none';
        return;
      }

      let html = '<div class="table-responsive"><table class="table table-sm">';
      html += '<thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>';

      cart.forEach((item, i) => {
        html += `
          <tr>
            <td>${item.name}</td>
            <td><span class="text-muted">${(item.purchasePrice || 0).toFixed(2)} Ø±ÙŠØ§Ù„</span></td>
            <td>
              <div class="input-group input-group-sm">
                <input type="text" class="form-control arabic-number-field" id="price_${i}"
                       value="${item.unitPrice.toFixed(2)}"
                       onchange="updateItemPrice(${i})" style="width: 80px;">
                <span class="input-group-text">Ø±ÙŠØ§Ù„</span>
              </div>
            </td>
            <td>
              <div class="input-group input-group-sm">
                <input type="text" class="form-control arabic-number-field" id="quantity_${i}"
                       value="${item.quantity}"
                       onchange="updateItemQuantity(${i})" style="width: 60px;">
              </div>
            </td>
            <td>${item.totalPrice.toFixed(2)} Ø±ÙŠØ§Ù„</td>
            <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${i})"><i class="fas fa-trash"></i></button></td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      cartItems.innerHTML = html;

      // Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
      setupArabicNumberSupport();

      updateCartSummary();
      cartSummary.style.display = 'block';
    }

    function updateCartSummary() {
      const total = cart.reduce((s, it) => s + it.totalPrice, 0);
      const totalProfit = cart.reduce((s, it) => s + (it.totalProfit || 0), 0);                                                                             
      const totalPurchaseCost = cart.reduce((s, it) => s + ((it.purchasePrice || 0) * it.quantity), 0);                                                     

      document.getElementById('cart_total').textContent = total.toFixed(2);
  
      // Ø¥Ø®ÙØ§Ø¡ ØµÙÙˆÙ ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø±Ø¨Ø­ (Ø§Ù„Ù…Ù†Ø·Ù‚ ÙŠØ¨Ù‚Ù‰ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† ØºÙŠØ± Ù…Ø±Ø¦ÙŠ)
      const cartSummary = document.getElementById('cart_summary');
      let purchaseCostElement = document.getElementById('cart_purchase_cost');
      let profitElement = document.getElementById('cart_profit');

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
      if (purchaseCostElement) {
        purchaseCostElement.parentElement.remove();
      }
      if (profitElement) {
        profitElement.parentElement.remove();
      }

      document.getElementById('complete_sale_btn').disabled = cart.length === 0;
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      updateCartDisplay();
    }

    function updateItemPrice(index) {
      const newPrice = parseArabicNumber(document.getElementById(`price_${index}`).value);
      if (newPrice < 0) {
        alert('Ø§Ù„Ø³Ø¹Ø± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹');
        document.getElementById(`price_${index}`).value = cart[index].unitPrice.toFixed(2);
        return;
      }
      cart[index].unitPrice = newPrice;
      cart[index].profit = newPrice - (cart[index].purchasePrice || 0);
      cart[index].totalPrice = newPrice * cart[index].quantity;
      cart[index].totalProfit = cart[index].profit * cart[index].quantity;
      updateCartDisplay();
    }
  
    function updateItemQuantity(index) {
      const newQty = Math.floor(parseArabicNumber(document.getElementById(`quantity_${index}`).value)) || 1;
      if (newQty < 1) {
        alert('Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 1 Ø£Ùˆ Ø£ÙƒØ«Ø±');
        document.getElementById(`quantity_${index}`).value = cart[index].quantity;
        return;
      }
      // ØªØ­Ù‚Ù‚ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª
      if (cart[index].type !== 'phone') {
        const opt = document.querySelector(`option[data-id="${cart[index].id}"]`);
        const availableStock = Math.floor(parseArabicNumber(opt?.getAttribute('data-stock') || '0'));
        if (availableStock && newQty > availableStock) {
          alert(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${newQty}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (${availableStock})`);
          document.getElementById(`quantity_${index}`).value = cart[index].quantity;
          return;
        }
      }
      cart[index].quantity = newQty;
      cart[index].totalPrice = cart[index].unitPrice * newQty;
      cart[index].totalProfit = cart[index].profit * newQty;
      updateCartDisplay();
    }
  
    // ====== Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù…Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ ÙˆØ§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª) ======
    function searchByBarcode() {
      const barcode = document.getElementById('barcode_search').value.trim();
      const resultDiv = document.getElementById('barcode_search_result');
      if (!barcode) { resultDiv.style.display = 'none'; return; }
  
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„Ø¨Ø­Ø«
      const englishBarcode = convertArabicToEnglishNumbers(barcode);
      const arabicBarcode = convertEnglishToArabicNumbers(barcode);
      
      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù†Ø³Ø®ØªÙŠÙ† (Ø¹Ø±Ø¨ÙŠØ© ÙˆØ¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)
      const searchTerms = [barcode, englishBarcode, arabicBarcode];
      const uniqueTerms = [...new Set(searchTerms)]; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±

      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø£ÙˆÙ„Ø§Ù‹
      const foundPhone = (phones || []).find(ph => {
        const phBarcode = ph.phone_number || ph.serial_number;
        const pid = ph.id || ph.phone_number;
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® (Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŒ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        return phBarcode && uniqueTerms.some(term => String(phBarcode) === term) && !isPhoneSold(pid);
      });

      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø§ØªÙ
      let foundAccessory = null;
      if (!foundPhone) {
        foundAccessory = (accessories || []).find(acc => {
          const accBarcode = acc.barcode || acc.barcode_id;
          return accBarcode && uniqueTerms.some(term => String(accBarcode) === term) && (acc.quantity_in_stock || acc.quantity || 0) > 0;
        });
      }
  
      if (foundPhone) {
        const manufacturer = foundPhone.manufacturer || foundPhone.brand || '';
        const model = foundPhone.model || '';
        const price = Number(foundPhone.selling_price) || 0;
        const purchase = Number(foundPhone.purchase_price) || 0;
        const profit = price - purchase;
  
        resultDiv.innerHTML = `
          <div class="alert alert-success">
            <h6><i class="fas fa-mobile-alt"></i> ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ:</h6>
            <p><strong>${manufacturer} ${model}</strong></p>
            <p>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode} | Ø§Ù„Ø³Ø¹Ø±: ${price} Ø±ÙŠØ§Ù„ | Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: ${purchase} Ø±ÙŠØ§Ù„</p>
            <button class="btn btn-sm btn-primary" onclick="selectPhoneByBarcode('${foundPhone.id || foundPhone.phone_number}')">
              <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
            </button>
          </div>
        `;
        resultDiv.style.display = 'block';
      } else if (foundAccessory) {
        const name = foundAccessory.name || '';
        const category = foundAccessory.category || '';
        const price = Number(foundAccessory.selling_price) || 0;
        const purchase = Number(foundAccessory.purchase_price) || 0;
        const quantity = foundAccessory.quantity_in_stock || foundAccessory.quantity || 0;
        const profit = price - purchase;
  
        resultDiv.innerHTML = `
          <div class="alert alert-info">
            <h6><i class="fas fa-box"></i> ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±:</h6>
            <p><strong>${name}</strong> (${category})</p>
            <p>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode} | Ø§Ù„Ø³Ø¹Ø±: ${price} Ø±ÙŠØ§Ù„ | Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: ${purchase} Ø±ÙŠØ§Ù„</p>
            <p>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${quantity}</p>
            <button class="btn btn-sm btn-primary" onclick="selectAccessoryByBarcode('${foundAccessory.id}')">
              <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
            </button>
          </div>
        `;
        resultDiv.style.display = 'block';
      } else {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆÙ„ÙƒÙ† ØªÙ… Ø¨ÙŠØ¹Ù‡ Ø£Ùˆ Ù†ÙØ¯Øª Ø§Ù„ÙƒÙ…ÙŠØ©
        const anyPhone = (phones || []).find(ph => {
          const phBarcode = ph.phone_number || ph.serial_number;
          return phBarcode && uniqueTerms.some(term => String(phBarcode) === term);
        });
        
        const anyAccessory = (accessories || []).find(acc => {
          const accBarcode = acc.barcode || acc.barcode_id;
          return accBarcode && uniqueTerms.some(term => String(accBarcode) === term);
        });

        if (anyPhone && isPhoneSold(anyPhone.id || anyPhone.phone_number)) {
          resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø§ØªÙ ØªÙ… Ø¨ÙŠØ¹Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹</div>`;
        } else if (anyAccessory && (anyAccessory.quantity_in_stock || anyAccessory.quantity || 0) <= 0) {
          resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Ù†ÙØ¯Øª ÙƒÙ…ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±</div>`;
        } else {
          resultDiv.innerHTML = `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}</div>`;
        }
        resultDiv.style.display = 'block';
      }
    }
  
    function selectPhoneByBarcode(phoneId) {
      const ph = (phones || []).find(p => (p.id || p.phone_number) === phoneId);
      if (!ph) return;
      const manufacturer = ph.manufacturer || ph.brand || '';
      const model = ph.model || '';
      const barcode = ph.phone_number || ph.serial_number || '';
      const sellingPrice = Number(ph.selling_price) || 0;
      const purchasePrice = Number(ph.purchase_price) || 0;
      const profit = sellingPrice - purchasePrice;
  
      cart.push({
        id: phoneId,
        type: 'phone',
        name: `${manufacturer} ${model}`.trim(),
        description: ph.description || '',
        serial_number: ph.serial_number || '',
        barcode: ph.phone_number || ph.serial_number || '',
        unitPrice: sellingPrice,
        purchasePrice,
        profit,
        quantity: 1,
        totalPrice: sellingPrice,
        totalProfit: profit,
        battery_level: ph.battery_level || null,
        condition: ph.condition || ph.phone_type || 'new'
      });
      updateCartDisplay();
  
      document.getElementById('barcode_search_result').style.display = 'none';
      document.getElementById('barcode_search').value = '';
      alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${manufacturer} ${model} (Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}) Ù„Ù„Ø³Ù„Ø©.\nØ³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹: ${sellingPrice} Ø±ÙŠØ§Ù„\nØ³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: ${purchasePrice} Ø±ÙŠØ§Ù„`);
    }

    function selectAccessoryByBarcode(accessoryId) {
      const acc = (accessories || []).find(a => a.id === accessoryId);
      if (!acc) return;
      
      const name = acc.name || '';
      const category = acc.category || '';
      const barcode = acc.barcode || '';
      const sellingPrice = Number(acc.selling_price) || 0;
      const purchasePrice = Number(acc.purchase_price) || 0;
      const profit = sellingPrice - purchasePrice;
      const quantity = acc.quantity_in_stock || acc.quantity || 0;

      cart.push({
        id: accessoryId,
        type: 'accessory',
        name: name,
        description: acc.description || '',
        category: category,
        barcode: barcode,
        unitPrice: sellingPrice,
        purchasePrice,
        profit,
        quantity: 1,
        totalPrice: sellingPrice,
        totalProfit: profit,
        availableQuantity: quantity
      });
      updateCartDisplay();

      document.getElementById('barcode_search_result').style.display = 'none';
      document.getElementById('barcode_search').value = '';
      alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${name} (${category}) Ù„Ù„Ø³Ù„Ø©.\nØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}\nØ³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹: ${sellingPrice} Ø±ÙŠØ§Ù„\nØ³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: ${purchasePrice} Ø±ÙŠØ§Ù„\nØ§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${quantity}`);
    }
  
    // ====== ØªÙ‚Ù„ÙŠÙ„ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª ======
    async function updateAccessoryStock() {
      try {
        console.log('ğŸ“¦ ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª...');
        
        for (const item of cart) {
          if (item.type !== 'phone') {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const accessory = accessories.find(acc => 
              (acc.id === item.id) || (acc.sku === item.id)
            );
            
            if (accessory) {
              const currentStock = Number(accessory.quantity_in_stock ?? accessory.quantity ?? 0);
              const newStock = Math.max(0, currentStock - item.quantity);
              
              console.log(`ğŸ“± ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† ${accessory.name}: ${currentStock} â†’ ${newStock}`);
              
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
              accessory.quantity_in_stock = newStock;
              accessory.quantity = newStock;
              
              // Ø­ÙØ¸ ÙÙŠ Firebase Ø£Ùˆ localStorage
              if (window.storage && window.storage.isFirebaseAvailable) {
                await window.storage.updateAccessory?.(accessory.id, accessory);
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙŠ Firebase');
              } else {
                // ØªØ­Ø¯ÙŠØ« localStorage
                const updatedAccessories = accessories.map(acc => 
                  acc.id === accessory.id ? accessory : acc
                );
                localStorage.setItem('accessories', JSON.stringify(updatedAccessories));
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙŠ localStorage');
              }
            } else {
              console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±: ${item.name} (ID: ${item.id})`);
            }
          }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await loadDataFromFirebase();
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª:', error);
        throw error;
      }
    }

    // ====== Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ (ÙŠØ­ÙØ¸ ÙÙŠ Firebase Ø¥Ù† ØªÙˆÙØ±Øª) ======
    let isProcessingSale = false; // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
    
    async function completeSale() {
      // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
      if (isProcessingSale) {
        console.log('â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ¹...');
        return;
      }
      
      if (cart.length === 0) { alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); return; }
      
      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
      isProcessingSale = true;
      const submitBtn = document.getElementById('complete_sale_btn');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
  
      const total = cart.reduce((s, it) => s + it.totalPrice, 0);
      const saleNumber = 'SALE-' + Date.now().toString().slice(-6);
      const totalProfit = cart.reduce((s, it) => s + (it.totalProfit || 0), 0);
      const totalPurchaseCost = cart.reduce((s, it) => s + ((it.purchasePrice || 0) * it.quantity), 0);

      const saleData = {
        sale_number: saleNumber,
        customer_name: document.getElementById('customer_name').value.trim() || 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ',
        customer_phone: document.getElementById('customer_phone').value.trim() || '',
        customer_email: document.getElementById('customer_email').value || '',
        customer_address: document.getElementById('customer_address').value || '',
        payment_method: document.getElementById('payment_method').value,
        notes: document.getElementById('notes').value || '',
        warranty: document.getElementById('warranty_input')?.value?.trim() || '',
        items: cart,
        total_amount: total,
        total_purchase_cost: totalPurchaseCost,
        total_profit: totalProfit,
        status: 'Ù…ÙƒØªÙ…Ù„',
        date_created: new Date().toISOString(),
        date_added: new Date().toISOString()
      };
  
      try {
        // ØªÙ‚Ù„ÙŠÙ„ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©
        await updateAccessoryStock();

        if (window.storage && window.storage.isFirebaseAvailable) {
          const saleId = await window.storage.addSale?.(saleData);
          if (!saleId) throw new Error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹ ÙÙŠ Firebase');
          saleData.id = saleId;
        } else {
          const sales = JSON.parse(localStorage.getItem('sales') || '[]');
          saleData.id = Date.now().toString();
          sales.push(saleData);
          localStorage.setItem('sales', JSON.stringify(sales));
        }

        localStorage.setItem('lastSale', JSON.stringify(saleData));
        alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹!\nØ±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${saleNumber}\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} Ø±ÙŠØ§Ù„\nØ³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: ${totalPurchaseCost.toFixed(2)} Ø±ÙŠØ§Ù„`);
  
      cart = [];
      updateCartDisplay();
        document.getElementById('customerForm')?.reset?.();
        document.getElementById('warranty_input').value = '';
  
        setTimeout(() => {
          window.location.href = `view_sale.html?id=${saleData.id}`;
        }, 800);
      } catch (err) {
        console.error('âŒ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ÙÙ‚Ø·
        isProcessingSale = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    }

    // ====== Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¶Ù…Ø§Ù† (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ÙŠØ§Ù‹) ======
    function loadWarrantyOptions() {
      try {
        const list = document.getElementById('warranty_options');
        if (!list) return;
        list.innerHTML = '';
        const options = JSON.parse(localStorage.getItem('warranty_options') || '[]');
        if (Array.isArray(options)) {
          options.forEach(val => {
            if (!val) return;
            const opt = document.createElement('option');
            opt.value = val;
            list.appendChild(opt);
          });
        }
      } catch (e) {
        // ignore
      }
    }

    function addWarrantyOption() {
      const input = document.getElementById('warranty_input');
      if (!input) return;
      const val = (input.value || '').trim();
      if (!val) return;
      try {
        const options = JSON.parse(localStorage.getItem('warranty_options') || '[]');
        if (!options.includes(val)) {
          options.push(val);
          localStorage.setItem('warranty_options', JSON.stringify(options));
          loadWarrantyOptions();
        }
      } catch (e) {
        // ignore
      }
    }
  
    // ====== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ======
    function logout() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        localStorage.removeItem('current_user');
        alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
        window.location.href = 'index.html';
      }
    }
  </script>

  <!-- Navigation Script -->
  <script src="js/navigation.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      initNavigation('create_sale');
    });
  </script>
  
</body>
</html>
