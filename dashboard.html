<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2c3e50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ù…Ù‡Ù†Ø¯ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</title>

  <!-- Ù†ÙØ³ Ø§Ù„Ø®Ø·/Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ù„Ø¨ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; padding-bottom: env(safe-area-inset-bottom); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding-top: env(safe-area-inset-top);
    }
    .navbar-brand, .nav-link { color: white !important; }
    /* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ */
    .card { border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .card-body { padding: 1.25rem; }
    .card-header { border-radius: 8px 8px 0 0 !important; font-weight: 600; }
    .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning {
      border: none; box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    }
    .card.bg-primary:hover, .card.bg-success:hover, .card.bg-info:hover, .card.bg-warning:hover {
      transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) {
      .card-body { padding: 1rem; }
      h3 { font-size: 1.5rem; }
      .fa-2x { font-size: 1.5em; }
    }
  </style>
</head>
<body>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand">Ù…Ù‡Ù†Ø¯ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <!-- Navigation will be populated by navigation.js -->
        </ul>
      </div>
    </div>
  </nav>

<div class="container-fluid mt-4">
  <!-- Main Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-3">
        <i class="fas fa-tachometer-alt text-primary"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </h2>
    </div>
  </div>

  <!-- Date Range Picker -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</h5>
        </div>
        <div class="card-body">
          <div class="row align-items-end">
            <div class="col-md-3">
              <label for="start_date" class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input type="date" class="form-control" id="start_date" />
            </div>
            <div class="col-md-3">
              <label for="end_date" class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input type="date" class="form-control" id="end_date" />
            </div>
            <div class="col-md-3">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid">
                <button class="btn btn-primary" onclick="applyDateFilter()">
                  <i class="fas fa-filter"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
                </button>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid">
                <button class="btn btn-outline-secondary" onclick="resetToCurrentMonth()">
                  <i class="fas fa-calendar-week"></i> Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                </button>
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-12">
              <small class="text-muted" id="period_indicator">Ø§Ù„ÙØªØ±Ø©: Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory Overview Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-mobile-alt fa-2x mb-2"></i>
          <h6 class="card-title mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‡ÙˆØ§ØªÙ</h6>
          <h3 class="mb-0" id="total_phones">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-cash-register fa-2x mb-2"></i>
          <h6 class="card-title mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h6>
          <h3 class="mb-0" id="total_sales_count">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
          <h6 class="card-title mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h6>
          <h3 class="mb-0" id="total_sales_amount">0</h3>
          <small>Ø±ÙŠØ§Ù„</small>
          <small class="d-block mt-1" style="opacity: 0.8;" id="sales_period_label">Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-coins fa-2x mb-2"></i>
          <h6 class="card-title mb-1">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ</h6>
          <h3 class="mb-0" id="total_actual_profit">0</h3>
          <small>Ø±ÙŠØ§Ù„</small>
          <small class="d-block mt-1" style="opacity: 0.8;" id="profit_period_label">Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Details Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-primary" id="total_purchase_value">0.00 Ø±ÙŠØ§Ù„</h3>
          <p class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-tags"></i> Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¨ÙŠØ¹ÙŠØ©</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-success" id="total_selling_value">0.00 Ø±ÙŠØ§Ù„</h3>
          <p class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line"></i> Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-warning" id="total_expected_profit">0.00 Ø±ÙŠØ§Ù„</h3>
          <p class="text-muted">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</p>
        </div>
      </div>
    </div>
  </div>


  <!-- Sales Performance Cards -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card bg-light h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>                                                                            
        </div>
        <div class="card-body text-center">
          <h3 class="text-primary" id="total_sales_amount_period">0.00 Ø±ÙŠØ§Ù„</h3>
          <p class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card bg-light h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-info" id="profit_ratio">0%</h3>
          <p class="text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-bolt"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-2">
              <a href="create_sale.html" class="btn btn-success btn-lg w-100">
                <i class="fas fa-plus-circle"></i><br>Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="add_new_phone.html" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-mobile"></i><br>Ø¥Ø¶Ø§ÙØ© Ù‡Ø§ØªÙ Ø¬Ø¯ÙŠØ¯
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="add_accessory.html" class="btn btn-info btn-lg w-100">
                <i class="fas fa-box"></i><br>Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ³Ø³ÙˆØ§Ø±
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="search.html" class="btn btn-warning btn-lg w-100">
                <i class="fas fa-search"></i><br>Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Sales -->
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-history"></i> Ø¢Ø®Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
        </div>
        <div class="card-body" id="recent_sales_wrap">
          <!-- ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·: Ø§Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ù„Ø¤Ù‡Ø§ Ø¹Ø¨Ø± JS Ù…Ù† API -->
          <div class="text-center py-4">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø¯ÙŠØ«Ø©</h5>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ù…ÙƒØªØ¨Ø§Øª JS Ù†ÙØ³Ù‡Ø§ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase Configuration -->
<script type="module" src="js/firebase-config-cdn.js"></script>
<script type="module" src="js/firebase-database-cdn.js"></script>
<script type="module" src="js/firebase-storage-manager.js"></script>

<!-- Ù†Ø¸Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<script>
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  function checkLogin() {
    const currentUser = localStorage.getItem('current_user');
    if (!currentUser) {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      window.location.href = 'login.html';
      return false;
    }
    
    try {
      const userData = JSON.parse(currentUser);
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±
      if (userData.role !== 'admin') {
        window.location.href = 'limited_dashboard.html';
        return false;
      }
      
      return true;
    } catch (error) {
      console.error('Error parsing user data:', error);
      localStorage.removeItem('current_user');
      window.location.href = 'login.html';
      return false;
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  function logout() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
      localStorage.removeItem('current_user');
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
      window.location.href = 'index.html';
    }
  }

  // ---------- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆÙ‚Øª/Ø§Ù„ØªØ§Ø±ÙŠØ® ----------
  // ÙŠØ­ÙˆÙ‘Ù„ Ø£ÙŠ Ù…Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® (Date | ISO string | number | Firestore Timestamp | {seconds/_seconds, nanoseconds/_nanoseconds}) Ø¥Ù„Ù‰ Date ØµØ§Ù„Ø­
  function normalizeToDate(v) {
    if (v == null) return null;

    // 1) Date Ø¬Ø§Ù‡Ø²
    if (v instanceof Date) {
      return isNaN(v.getTime()) ? null : v;
    }

    // 2) Firestore Timestamp: toDate()
    if (typeof v === 'object') {
      if (typeof v.toDate === 'function') {
        const d = v.toDate();
        return isNaN(d?.getTime()) ? null : d;
      }
      // 3) Ø´ÙƒÙ„ seconds/nanoseconds Ø£Ùˆ _seconds/_nanoseconds
      if ('seconds' in v || '_seconds' in v) {
        const sec  = Number(v.seconds ?? v._seconds ?? 0);
        const nsec = Number(v.nanoseconds ?? v._nanoseconds ?? 0);
        const ms = (sec * 1000) + Math.floor(nsec / 1e6);
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
    }

    // 4) Ø±Ù‚Ù…: ms Ø£Ùˆ s
    if (typeof v === 'number') {
      const ms = v > 1e12 ? v : v * 1000; // Ø¥Ø°Ø§ Ø£Ù‚Ù„ Ù…Ù† 1e12 Ù†ÙØªØ±Ø¶ Ø«ÙˆØ§Ù†ÙŠ
      const d = new Date(ms);
      return isNaN(d.getTime()) ? null : d;
    }

    // 5) Ø³ØªØ±Ù†Ù‚: ISO Ø£Ùˆ Ø±Ù‚Ù…ÙŠØ©
    if (typeof v === 'string') {
      const s = v.trim();
      if (/^\d+$/.test(s)) {
        const n = parseInt(s, 10);
        const ms = n > 1e12 ? n : n * 1000;
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
      const d = new Date(s); // Ù…Ø«Ù„ "2025-09-20T11:34:48.797Z"
      return isNaN(d.getTime()) ? null : d;
    }

    return null;
  }

  // ÙŠØ±Ø¬Ù‘Ø¹ Ø£ÙØ¶Ù„ ØªØ§Ø±ÙŠØ® Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
  function getSaleDateValue(sale) {
    return (
      normalizeToDate(sale?.date_created) ||
      normalizeToDate(sale?.date_added)   ||
      normalizeToDate(sale?.createdAt)    ||
      normalizeToDate(sale?.created_at)   ||
      null
    );
  }

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù„Ø§ØªÙŠÙ†ÙŠØ© â€” ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
  function convertToLatinNumbers(input) {
    if (input == null) return '';
    const str = String(input);
    const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return str.replace(/[Ù -Ù©]/g, d => map[d] || d);
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ¹ Ø§Ù„Ù‡Ø§ØªÙ
  function isPhoneSold(phoneId, salesData = []) {
    try {
      const rawSales = salesData.length > 0 ? salesData : JSON.parse(localStorage.getItem('sales') || '[]');
      const sales = (rawSales || []).filter(s => s && s.returned !== true && s.status !== 'Ù…Ø³ØªØ±Ø¬Ø¹Ø©');
      return sales.some(sale =>
        Array.isArray(sale.items) &&
        sale.items.some(item => item.type === 'phone' && (item.id === phoneId || item.phone_id === phoneId))
      );
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ¹ Ø§Ù„Ù‡Ø§ØªÙ:', error);
      return false;
    }
  }

  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  function getDateRange() {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    let startDate, endDate;
    
    if (startDateInput.value && endDateInput.value) {
      startDate = new Date(startDateInput.value);
      endDate = new Date(endDateInput.value);
      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…
      startDate.setHours(0, 0, 0, 0);
      endDate.setHours(23, 59, 59, 999);
    } else {
      // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
      const now = new Date();
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    }
    
    return { startDate, endDate };
  }

  // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
  function filterSalesByDateRange(sales, startDate, endDate) {
    return sales.filter(sale => {
      const saleDate = getSaleDateValue(sale);
      if (!saleDate) return false;
      
      return saleDate >= startDate && saleDate <= endDate;
    });
  }

  // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ÙØªØ±Ø©
  function updatePeriodIndicator() {
    const { startDate, endDate } = getDateRange();
    const indicator = document.getElementById('period_indicator');
    const salesLabel = document.getElementById('sales_period_label');
    const profitLabel = document.getElementById('profit_period_label');
    
    const formatDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    
    const startStr = formatDate(startDate);
    const endStr = formatDate(endDate);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙØªØ±Ø© Ù‡ÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    const now = new Date();
    const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const currentMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    
    let periodText = '';
    if (startDate.getTime() === currentMonthStart.getTime() && 
        endDate.getTime() === currentMonthEnd.getTime()) {
      periodText = 'Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ';
      if (indicator) indicator.textContent = 'Ø§Ù„ÙØªØ±Ø©: Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ';
    } else {
      periodText = `Ù…Ù† ${startStr} Ø¥Ù„Ù‰ ${endStr}`;
      if (indicator) indicator.textContent = `Ø§Ù„ÙØªØ±Ø©: ${periodText}`;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³Ù…ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    if (salesLabel) salesLabel.textContent = periodText;
    if (profitLabel) profitLabel.textContent = periodText;
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
  function initializeDateRange() {
    const now = new Date();
    const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    if (startDateInput && endDateInput) {
      startDateInput.value = startDate.toISOString().split('T')[0];
      endDateInput.value = endDate.toISOString().split('T')[0];
      updatePeriodIndicator();
    }
  }

  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
  function applyDateFilter() {
    updateDashboard();
  }

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
  function resetToCurrentMonth() {
    initializeDateRange();
    updateDashboard();
  }

  // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
  async function updateDashboard() {
    try {
      // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø£Ùˆ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
      let phones = [];
      let accessories = [];
      let sales = [];
      
      if (window.storage && window.storage.isFirebaseAvailable) {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase
        phones = await window.storage.getPhones();
        accessories = await window.storage.getAccessories();
        sales = await window.storage.getSales();
      } else {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… LocalStorage ÙƒØ¨Ø¯ÙŠÙ„
        phones = JSON.parse(localStorage.getItem('phones') || '[]');
        accessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        sales = JSON.parse(localStorage.getItem('sales') || '[]');
      }

      // ØªØµÙÙŠØ© Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© - Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø·
      const availablePhones = phones.filter(phone => {
        const phoneId = phone.id || phone.phone_number;
        return phoneId && !isPhoneSold(phoneId, sales);
      });

      console.log('ğŸ“± Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…ØªØ§Ø­Ø©:', availablePhones.length, 'Ù…Ù† Ø£ØµÙ„', phones.length);

      // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù‡ÙˆØ§ØªÙ (Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø·)
      const totalPhones = availablePhones.length;
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø·
      const phonesPurchaseValue = availablePhones.reduce((sum, phone) => sum + (phone.purchase_price || 0), 0);
      const phonesSellingValue = availablePhones.reduce((sum, phone) => sum + (phone.selling_price || 0), 0);
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø§Ù„ÙƒÙ…ÙŠØ© > 0)
      const availableAccessories = accessories.filter(acc => (acc.quantity_in_stock || acc.quantity || 0) > 0);
      const accessoriesPurchaseValue = availableAccessories.reduce((sum, acc) => sum + (acc.purchase_price || 0) * (acc.quantity_in_stock || acc.quantity || 0), 0);
      const accessoriesSellingValue = availableAccessories.reduce((sum, acc) => sum + (acc.selling_price || 0) * (acc.quantity_in_stock || acc.quantity || 0), 0);
      
      // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ… (Ù‡ÙˆØ§ØªÙ + Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª)
      const totalPurchaseValue = phonesPurchaseValue + accessoriesPurchaseValue;
      const totalSellingValue = phonesSellingValue + accessoriesSellingValue;
      const totalExpectedProfit = totalSellingValue - totalPurchaseValue;

      console.log('ğŸ“± Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…ØªØ§Ø­Ø©:', availablePhones.length, 'Ù…Ù† Ø£ØµÙ„', phones.length);
      console.log('ğŸ“¦ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', availableAccessories.length, 'Ù…Ù† Ø£ØµÙ„', accessories.length);
      console.log('ğŸ’° Ù‚ÙŠÙ…Ø© Ø´Ø±Ø§Ø¡ Ø§Ù„Ù‡ÙˆØ§ØªÙ:', phonesPurchaseValue);
      console.log('ğŸ’° Ù‚ÙŠÙ…Ø© Ø´Ø±Ø§Ø¡ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª:', accessoriesPurchaseValue);
      console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©:', totalPurchaseValue);

      document.getElementById('total_phones').textContent = convertToLatinNumbers(totalPhones);
      document.getElementById('total_purchase_value').textContent = convertToLatinNumbers(totalPurchaseValue.toFixed(2)) + ' Ø±ÙŠØ§Ù„';
      document.getElementById('total_selling_value').textContent = convertToLatinNumbers(totalSellingValue.toFixed(2)) + ' Ø±ÙŠØ§Ù„';
      document.getElementById('total_expected_profit').textContent = convertToLatinNumbers(totalExpectedProfit.toFixed(2)) + ' Ø±ÙŠØ§Ù„';


      // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©)
      let effectiveSales = (sales || []).filter(s => s && s.returned !== true && s.status !== 'Ù…Ø³ØªØ±Ø¬Ø¹Ø©');
      
      // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
      const { startDate, endDate } = getDateRange();
      effectiveSales = filterSalesByDateRange(effectiveSales, startDate, endDate);
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ÙØªØ±Ø©
      updatePeriodIndicator();
      
      const totalSales = effectiveSales.length;
      const totalSalesAmount = effectiveSales.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ: Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ - Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
      let totalActualProfit = 0;
      let totalPurchaseCost = 0;
      
      effectiveSales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            // Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ù…Ù† Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª)
            const sellingPrice = item.unitPrice || item.unit_price || 0;                                                                            
            const quantity = item.quantity || 1;
            const totalSellingPrice = sellingPrice * quantity;                                                                              
            
            // Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            let purchasePrice = 0;
            if (item.type === 'phone') {
              const phone = phones.find(p => (p.id === item.id || p.phone_id === item.id || p.phone_number === item.id));
              if (phone) {
                purchasePrice = (phone.purchase_price || 0);
              }
            } else {
              const accessory = accessories.find(a => (a.id === item.id || a.sku === item.id));
              if (accessory) {
                purchasePrice = (accessory.purchase_price || 0);
              }
            }
            
            const totalPurchasePrice = purchasePrice * quantity;
            const itemProfit = totalSellingPrice - totalPurchasePrice;
            
            totalActualProfit += itemProfit;
            totalPurchaseCost += totalPurchasePrice;
          });
        }
      });

      // Ø¬Ù„Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØµÙÙŠØªÙ‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©
      let maintenanceProfit = 0;
      let maintenanceJobs = [];
      try {
        console.log('ğŸ” Ø¬Ù„Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ§Ù†Ø©...');
        const allMaintenanceJobs = await window.firebaseDatabase.getMaintenanceJobs({ status: 'done' });
        console.log('ğŸ” ØªÙ… Ø¬Ù„Ø¨ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©:', allMaintenanceJobs.length, 'Ø¹Ù…Ù„');
        
        // ØªØµÙÙŠØ© Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
        maintenanceJobs = allMaintenanceJobs.filter(job => {
          const jobDate = normalizeToDate(job.dateCompleted || job.date_completed || job.createdAt || job.created_at);
          if (!jobDate) return false;
          return jobDate >= startDate && jobDate <= endDate;
        });
        
        maintenanceProfit = maintenanceJobs.reduce((sum, job) => {
          const shopProfit = job.shopProfit || 0;
          console.log(`ğŸ”§ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ§Ù†Ø©: ${job.customerName} = ${shopProfit} Ø±ÙŠØ§Ù„`);
          return sum + shopProfit;
        }, 0);
        
        console.log('ğŸ”§ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„ÙØªØ±Ø©:', maintenanceProfit, 'Ø±ÙŠØ§Ù„');
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ§Ù†Ø©:', error);
        maintenanceProfit = 0;
        maintenanceJobs = [];
      }

      // Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ
      totalActualProfit += maintenanceProfit;
      console.log('ğŸ’° Ø±Ø¨Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', totalActualProfit - maintenanceProfit);
      console.log('ğŸ’° Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ§Ù†Ø©:', maintenanceProfit);
      console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ (Ù…Ø¨ÙŠØ¹Ø§Øª + ØµÙŠØ§Ù†Ø©):', totalActualProfit);

      // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ Ã· Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª)
      const salesProfit = totalActualProfit - maintenanceProfit;
      const actualProfitRatio = totalSalesAmount > 0 ? (totalActualProfit / totalSalesAmount) * 100 : 0;
      
      // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ù…Ø¨ÙŠØ¹Ø§Øª + ØµÙŠØ§Ù†Ø©)
      const maintenanceRevenue = maintenanceJobs ? maintenanceJobs.reduce((sum, job) => sum + (job.amountCharged || 0), 0) : 0;
      const totalRevenue = totalSalesAmount + maintenanceRevenue;
      const totalProfitRatio = totalRevenue > 0 ? (totalActualProfit / totalRevenue) * 100 : 0;

      console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:', totalSalesAmount);
      console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:', totalPurchaseCost);
      console.log('ğŸ’° Ø±Ø¨Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙ‚Ø·:', salesProfit);
      console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ (Ù…Ø¨ÙŠØ¹Ø§Øª + ØµÙŠØ§Ù†Ø©):', totalActualProfit);
      console.log('ğŸ’° Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ø§Ù„Ø±Ø¨Ø­ Ã· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª):', actualProfitRatio.toFixed(2) + '%');
      console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ù…Ø¨ÙŠØ¹Ø§Øª + ØµÙŠØ§Ù†Ø©):', totalRevenue);
      console.log('ğŸ’° Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:', totalProfitRatio.toFixed(2) + '%');

      document.getElementById('total_sales_count').textContent = convertToLatinNumbers(totalSales);                                                         
      document.getElementById('total_sales_amount').textContent = convertToLatinNumbers(totalSalesAmount.toFixed(0));                                       
      document.getElementById('total_actual_profit').textContent = convertToLatinNumbers(totalActualProfit.toFixed(2));
      
      // ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
      const totalSalesAmountElement = document.getElementById('total_sales_amount_period');
      if (totalSalesAmountElement) {
        totalSalesAmountElement.textContent = convertToLatinNumbers(totalSalesAmount.toFixed(0)) + ' Ø±ÙŠØ§Ù„';
      }

      // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­
      document.getElementById('profit_ratio').textContent = convertToLatinNumbers(actualProfitRatio.toFixed(1)) + '%';

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ´Ø®ÙŠØµ
      console.log('ğŸ’° Ø±Ø¨Ø­ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', salesProfit);
      console.log('ğŸ’° Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ§Ù†Ø©:', maintenanceProfit);
      console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ:', totalActualProfit);
      console.log('ğŸ’° Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', totalSalesAmount);
      console.log('ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:', totalRevenue);
      console.log('ğŸ’° Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠØ© (Ø§Ù„Ø±Ø¨Ø­ Ã· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª):', actualProfitRatio.toFixed(2) + '%');
      console.log('ğŸ’° Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:', totalProfitRatio.toFixed(2) + '%');

      // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©)
      updateRecentSales(effectiveSales);

    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', error);
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ù‚Ø³Ù… Ø¢Ø®Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  function updateRecentSales(sales) {
    const recentSalesContainer = document.getElementById('recent_sales_wrap');
    
    if (!sales || sales.length === 0) {
      recentSalesContainer.innerHTML = `
        <div class="text-center py-4">
          <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø¯ÙŠØ«Ø©</h5>
        </div>
      `;
      return;
    }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹) ÙˆØ§Ø®ØªÙŠØ§Ø± Ø¢Ø®Ø± 5
    const sortedSales = sales
      .sort((a, b) => {
        const dateA = getSaleDateValue(a) || new Date(0);
        const dateB = getSaleDateValue(b) || new Date(0);
        return dateB - dateA;
      })
      .slice(0, 5);

    let salesHTML = '';
    
    sortedSales.forEach(sale => {
      const saleDate = getSaleDateValue(sale) || new Date();
      const formattedDate = formatDate(saleDate);
      const customerName = sale.customer_name || 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ';
      const totalAmount = sale.total_amount || 0;
      const itemCount = sale.items ? sale.items.length : 0;
      const status = sale.status || 'Ù…ÙƒØªÙ…Ù„';
      
      // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø©
      let statusBadge = 'bg-warning';
      if (status === 'Ù…ÙƒØªÙ…Ù„') statusBadge = 'bg-success';
      else if (status === 'Ù…Ù„ØºÙŠ') statusBadge = 'bg-danger';

      salesHTML += `
        <div class="row align-items-center py-2 border-bottom">
          <div class="col-md-2">
            <span class="badge bg-primary">${sale.sale_number || sale.id || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
          </div>
          <div class="col-md-2">
            <small class="text-muted">${formattedDate}</small>
          </div>
          <div class="col-md-3">
            <strong>${customerName}</strong>
          </div>
          <div class="col-md-2">
            <span class="badge bg-info">${convertToLatinNumbers(itemCount)} Ù…Ù†ØªØ¬</span>
          </div>
          <div class="col-md-2">
            <strong class="text-success">${convertToLatinNumbers(totalAmount.toFixed(2))} Ø±ÙŠØ§Ù„</strong>
          </div>
          <div class="col-md-1">
            <span class="badge ${statusBadge}">${status}</span>
          </div>
        </div>
      `;
    });

    recentSalesContainer.innerHTML = `
      <div class="table-responsive">
        <div class="row fw-bold text-muted border-bottom pb-2 mb-2">
          <div class="col-md-2">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
          <div class="col-md-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
          <div class="col-md-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <div class="col-md-2">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
          <div class="col-md-2">Ø§Ù„Ù…Ø¨Ù„Øº</div>
          <div class="col-md-1">Ø§Ù„Ø­Ø§Ù„Ø©</div>
        </div>
        ${salesHTML}
      </div>
      <div class="text-center mt-3">
        <a href="list_sales.html" class="btn btn-outline-success">
          <i class="fas fa-list"></i> Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        </a>
      </div>
    `;
  }

  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ø±Ø¶
  function formatDate(anyDate) {
    const d = normalizeToDate(anyDate);
    if (!d) return '-';
    
    try {
      const pad = x => String(x).padStart(2,'0');
      const year    = d.getFullYear();
      const month   = pad(d.getMonth() + 1);
      const day     = pad(d.getDate());
      const hours   = pad(d.getHours());
      const minutes = pad(d.getMinutes());
      
      return `${convertToLatinNumbers(year)}-${convertToLatinNumbers(month)}-${convertToLatinNumbers(day)} ${convertToLatinNumbers(hours)}:${convertToLatinNumbers(minutes)}`;
    } catch {
      return '-';
    }
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', async function() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
    if (!checkLogin()) return;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    initializeDateRange();

    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Firebase
    await new Promise(resolve => setTimeout(resolve, 1000));

    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    await updateDashboard();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
    setInterval(async () => {
      await updateDashboard();
    }, 10000);
  });
</script>

<!-- Navigation Script -->
<script src="js/navigation.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    initNavigation('dashboard');
  });
</script>
</body>
</html>
