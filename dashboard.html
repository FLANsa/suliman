<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ููุญุฉ ุงูุชุญูู โ ูุงุณุฑ ููุงุชุตุงูุงุช</title>

  <!-- ููุณ ุงูุฎุท/ุงูููุชุจุงุช ุงููุณุชุฎุฏูุฉ ูู ุงููุงูุจ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    /* ููุณ ุงูุชูุณููุงุช ุงููุฎุตุตุฉ ูู ุงูููู ุงูุฃุตูู */
    .card { border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease-in-out; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .card-body { padding: 1.25rem; }
    .card-header { border-radius: 8px 8px 0 0 !important; font-weight: 600; }
    .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning {
      border: none; box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    }
    .card.bg-primary:hover, .card.bg-success:hover, .card.bg-info:hover, .card.bg-warning:hover {
      transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) {
      .card-body { padding: 1rem; }
      h3 { font-size: 1.5rem; }
      .fa-2x { font-size: 1.5em; }
    }
  </style>
</head>
<body>

  <!-- ุดุฑูุท ุงูุชููู -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand">ูุงุณุฑ ููุงุชุตุงูุงุช</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <!-- Navigation will be populated by navigation.js -->
        </ul>
      </div>
    </div>
  </nav>

<div class="container-fluid mt-4">
  <!-- Main Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-3">
        <i class="fas fa-tachometer-alt text-primary"></i> ููุญุฉ ุงูุชุญูู
      </h2>
    </div>
  </div>

  <!-- Date Range Picker -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> ุงุฎุชูุงุฑ ุงููุชุฑุฉ ุงูุฒูููุฉ</h5>
        </div>
        <div class="card-body">
          <div class="row align-items-end">
            <div class="col-md-3">
              <label for="start_date" class="form-label">ูู ุชุงุฑูุฎ</label>
              <input type="date" class="form-control" id="start_date" />
            </div>
            <div class="col-md-3">
              <label for="end_date" class="form-label">ุฅูู ุชุงุฑูุฎ</label>
              <input type="date" class="form-control" id="end_date" />
            </div>
            <div class="col-md-3">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid">
                <button class="btn btn-primary" onclick="applyDateFilter()">
                  <i class="fas fa-filter"></i> ุชุทุจูู ุงูููุชุฑ
                </button>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid">
                <button class="btn btn-outline-secondary" onclick="resetToCurrentMonth()">
                  <i class="fas fa-calendar-week"></i> ุงูุดูุฑ ุงูุญุงูู
                </button>
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-12">
              <small class="text-muted" id="period_indicator">ุงููุชุฑุฉ: ุงูุดูุฑ ุงูุญุงูู</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory Overview Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-mobile-alt fa-2x mb-2"></i>
          <h6 class="card-title mb-1">ุฅุฌูุงูู ุงูููุงุชู</h6>
          <h3 class="mb-0" id="total_phones">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-cash-register fa-2x mb-2"></i>
          <h6 class="card-title mb-1">ุนุฏุฏ ุงููุจูุนุงุช</h6>
          <h3 class="mb-0" id="total_sales_count">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
          <h6 class="card-title mb-1">ุฅุฌูุงูู ุงููุจูุนุงุช</h6>
          <h3 class="mb-0" id="total_sales_amount">0</h3>
          <small>ุฑูุงู</small>
          <small class="d-block mt-1" style="opacity: 0.8;" id="sales_period_label">ููุดูุฑ ุงูุญุงูู</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white h-100">
        <div class="card-body text-center py-3">
          <i class="fas fa-coins fa-2x mb-2"></i>
          <h6 class="card-title mb-1">ุงูุฑุจุญ ุงููุนูู</h6>
          <h3 class="mb-0" id="total_actual_profit">0</h3>
          <small>ุฑูุงู</small>
          <small class="d-block mt-1" style="opacity: 0.8;" id="profit_period_label">ููุดูุฑ ุงูุญุงูู</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Financial Details Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> ุงูููู ุงูุดุฑุงุฆูุฉ</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-primary" id="total_purchase_value">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุฅุฌูุงูู ูููุฉ ุดุฑุงุก ุงููุฎุฒูู ุงููุชุงุญ</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-tags"></i> ุงูููู ุงูุจูุนูุฉ</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-success" id="total_selling_value">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุฅุฌูุงูู ูููุฉ ุจูุน ุงููุฎุฒูู ุงููุชุงุญ</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line"></i> ุงูุฑุจุญ ุงููุชููุน</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-warning" id="total_expected_profit">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุงูุฑุจุญ ุงููุชููุน ูู ุงููุฎุฒูู ุงููุชุงุญ</p>
        </div>
      </div>
    </div>
  </div>


  <!-- Sales Performance Cards -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card bg-light h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line"></i> ุฅุฌูุงูู ุงููุจูุนุงุช</h5>                                                                            
        </div>
        <div class="card-body text-center">
          <h3 class="text-primary" id="total_sales_amount_period">0.00 ุฑูุงู</h3>
          <p class="text-muted">ุฅุฌูุงูู ุงููุจูุนุงุช ูููุชุฑุฉ ุงููุญุฏุฏุฉ</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card bg-light h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-chart-pie"></i> ูุณุจุฉ ุงูุฑุจุญ</h5>
        </div>
        <div class="card-body text-center">
          <h3 class="text-info" id="profit_ratio">0%</h3>
          <p class="text-muted">ูุณุจุฉ ุงูุฑุจุญ ูู ุงููุจูุนุงุช</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-bolt"></i> ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-2">
              <a href="create_sale.html" class="btn btn-success btn-lg w-100">
                <i class="fas fa-plus-circle"></i><br>ุฅูุดุงุก ุนูููุฉ ุจูุน
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="add_new_phone.html" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-mobile"></i><br>ุฅุถุงูุฉ ูุงุชู ุฌุฏูุฏ
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="add_accessory.html" class="btn btn-info btn-lg w-100">
                <i class="fas fa-box"></i><br>ุฅุถุงูุฉ ุฃูุณุณูุงุฑ
              </a>
            </div>
            <div class="col-md-3 mb-2">
              <a href="search.html" class="btn btn-warning btn-lg w-100">
                <i class="fas fa-search"></i><br>ุงูุจุญุซ ูู ุงููุฎุฒูู
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Sales -->
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-history"></i> ุขุฎุฑ ุงููุจูุนุงุช</h5>
        </div>
        <div class="card-body" id="recent_sales_wrap">
          <!-- ูุงุฌูุฉ ููุท: ุงุนุฑุถ ุฑุณุงูุฉ ูุงุฑุบุฉ. ููููู ูุงุญููุง ููุคูุง ุนุจุฑ JS ูู API -->
          <div class="text-center py-4">
            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">ูุง ุชูุฌุฏ ูุจูุนุงุช ุญุฏูุซุฉ</h5>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ููุชุจุงุช JS ููุณูุง -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase Configuration -->
<script type="module" src="js/firebase-config-cdn.js"></script>
<script type="module" src="js/firebase-database-cdn.js"></script>
<script type="module" src="js/firebase-storage-manager.js"></script>

<!-- ูุธุงู ููุญุฉ ุงูุชุญูู ูุน ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู -->
<script>
  // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
  function checkLogin() {
    const currentUser = localStorage.getItem('current_user');
    if (!currentUser) {
      // ุฅุนุงุฏุฉ ุชูุฌูู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู
      alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
      window.location.href = 'login.html';
      return false;
    }
    
    try {
      const userData = JSON.parse(currentUser);
      
      // ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุฏูุฑ
      if (userData.role !== 'admin') {
        window.location.href = 'limited_dashboard.html';
        return false;
      }
      
      return true;
    } catch (error) {
      console.error('Error parsing user data:', error);
      localStorage.removeItem('current_user');
      window.location.href = 'login.html';
      return false;
    }
  }

  // ุชุณุฌูู ุงูุฎุฑูุฌ
  function logout() {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
      localStorage.removeItem('current_user');
      alert('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ ุจูุฌุงุญ');
      window.location.href = 'index.html';
    }
  }

  // ---------- ุฃุฏูุงุช ูุณุงุนุฏุฉ ููููุช/ุงูุชุงุฑูุฎ ----------
  // ูุญููู ุฃู ูุฏุฎู ุชุงุฑูุฎ (Date | ISO string | number | Firestore Timestamp | {seconds/_seconds, nanoseconds/_nanoseconds}) ุฅูู Date ุตุงูุญ
  function normalizeToDate(v) {
    if (v == null) return null;

    // 1) Date ุฌุงูุฒ
    if (v instanceof Date) {
      return isNaN(v.getTime()) ? null : v;
    }

    // 2) Firestore Timestamp: toDate()
    if (typeof v === 'object') {
      if (typeof v.toDate === 'function') {
        const d = v.toDate();
        return isNaN(d?.getTime()) ? null : d;
      }
      // 3) ุดูู seconds/nanoseconds ุฃู _seconds/_nanoseconds
      if ('seconds' in v || '_seconds' in v) {
        const sec  = Number(v.seconds ?? v._seconds ?? 0);
        const nsec = Number(v.nanoseconds ?? v._nanoseconds ?? 0);
        const ms = (sec * 1000) + Math.floor(nsec / 1e6);
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
    }

    // 4) ุฑูู: ms ุฃู s
    if (typeof v === 'number') {
      const ms = v > 1e12 ? v : v * 1000; // ุฅุฐุง ุฃูู ูู 1e12 ููุชุฑุถ ุซูุงูู
      const d = new Date(ms);
      return isNaN(d.getTime()) ? null : d;
    }

    // 5) ุณุชุฑูู: ISO ุฃู ุฑูููุฉ
    if (typeof v === 'string') {
      const s = v.trim();
      if (/^\d+$/.test(s)) {
        const n = parseInt(s, 10);
        const ms = n > 1e12 ? n : n * 1000;
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
      const d = new Date(s); // ูุซู "2025-09-20T11:34:48.797Z"
      return isNaN(d.getTime()) ? null : d;
    }

    return null;
  }

  // ูุฑุฌูุน ุฃูุถู ุชุงุฑูุฎ ููุฌูุฏ ูู ุงูุณุฌู
  function getSaleDateValue(sale) {
    return (
      normalizeToDate(sale?.date_created) ||
      normalizeToDate(sale?.date_added)   ||
      normalizeToDate(sale?.createdAt)    ||
      normalizeToDate(sale?.created_at)   ||
      null
    );
  }

  // ุชุญููู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ุฅูู ูุงุชูููุฉ โ ูุฏุนู ุงููุฏุฎูุงุช ุงูุฑูููุฉ
  function convertToLatinNumbers(input) {
    if (input == null) return '';
    const str = String(input);
    const map = {'ู':'0','ูก':'1','ูข':'2','ูฃ':'3','ูค':'4','ูฅ':'5','ูฆ':'6','ูง':'7','ูจ':'8','ูฉ':'9'};
    return str.replace(/[ู-ูฉ]/g, d => map[d] || d);
  }

  // ุงูุชุญูู ูู ุจูุน ุงููุงุชู
  function isPhoneSold(phoneId, salesData = []) {
    try {
      const rawSales = salesData.length > 0 ? salesData : JSON.parse(localStorage.getItem('sales') || '[]');
      const sales = (rawSales || []).filter(s => s && s.returned !== true && s.status !== 'ูุณุชุฑุฌุนุฉ');
      return sales.some(sale =>
        Array.isArray(sale.items) &&
        sale.items.some(item => item.type === 'phone' && (item.id === phoneId || item.phone_id === phoneId))
      );
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุงูุชุญูู ูู ุจูุน ุงููุงุชู:', error);
      return false;
    }
  }

  // ุงูุญุตูู ุนูู ุงููุชุฑุฉ ุงูุฒูููุฉ ุงููุญุฏุฏุฉ
  function getDateRange() {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    let startDate, endDate;
    
    if (startDateInput.value && endDateInput.value) {
      startDate = new Date(startDateInput.value);
      endDate = new Date(endDateInput.value);
      // ุชุนููู ุงูููุช ุฅูู ุจุฏุงูุฉ ุงูููู ูููุงูุฉ ุงูููู
      startDate.setHours(0, 0, 0, 0);
      endDate.setHours(23, 59, 59, 999);
    } else {
      // ุงูุชุฑุงุถู: ุงูุดูุฑ ุงูุญุงูู
      const now = new Date();
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    }
    
    return { startDate, endDate };
  }

  // ุชุตููุฉ ุงููุจูุนุงุช ุญุณุจ ุงููุชุฑุฉ ุงูุฒูููุฉ
  function filterSalesByDateRange(sales, startDate, endDate) {
    return sales.filter(sale => {
      const saleDate = getSaleDateValue(sale);
      if (!saleDate) return false;
      
      return saleDate >= startDate && saleDate <= endDate;
    });
  }

  // ุชุญุฏูุซ ูุคุดุฑ ุงููุชุฑุฉ
  function updatePeriodIndicator() {
    const { startDate, endDate } = getDateRange();
    const indicator = document.getElementById('period_indicator');
    const salesLabel = document.getElementById('sales_period_label');
    const profitLabel = document.getElementById('profit_period_label');
    
    const formatDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    };
    
    const startStr = formatDate(startDate);
    const endStr = formatDate(endDate);
    
    // ุงูุชุญูู ุฅุฐุง ูุงูุช ุงููุชุฑุฉ ูู ุงูุดูุฑ ุงูุญุงูู
    const now = new Date();
    const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const currentMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    
    let periodText = '';
    if (startDate.getTime() === currentMonthStart.getTime() && 
        endDate.getTime() === currentMonthEnd.getTime()) {
      periodText = 'ููุดูุฑ ุงูุญุงูู';
      if (indicator) indicator.textContent = 'ุงููุชุฑุฉ: ุงูุดูุฑ ุงูุญุงูู';
    } else {
      periodText = `ูู ${startStr} ุฅูู ${endStr}`;
      if (indicator) indicator.textContent = `ุงููุชุฑุฉ: ${periodText}`;
    }
    
    // ุชุญุฏูุซ ุงูุชุณููุงุช ูู ุงูุจุทุงูุงุช
    if (salesLabel) salesLabel.textContent = periodText;
    if (profitLabel) profitLabel.textContent = periodText;
  }

  // ุชููุฆุฉ ุงูุชูุงุฑูุฎ ุฅูู ุงูุดูุฑ ุงูุญุงูู
  function initializeDateRange() {
    const now = new Date();
    const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    if (startDateInput && endDateInput) {
      startDateInput.value = startDate.toISOString().split('T')[0];
      endDateInput.value = endDate.toISOString().split('T')[0];
      updatePeriodIndicator();
    }
  }

  // ุชุทุจูู ุงูููุชุฑ
  function applyDateFilter() {
    updateDashboard();
  }

  // ุฅุนุงุฏุฉ ุชุนููู ุฅูู ุงูุดูุฑ ุงูุญุงูู
  function resetToCurrentMonth() {
    initializeDateRange();
    updateDashboard();
  }

  // ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู ุจุงูุจูุงูุงุช ุงูุญููููุฉ
  async function updateDashboard() {
    try {
      // ุฌูุจ ุงูุจูุงูุงุช ูู Firebase ุฃู ุงูุชุฎุฒูู ุงููุญูู
      let phones = [];
      let accessories = [];
      let sales = [];
      
      if (window.storage && window.storage.isFirebaseAvailable) {
        // ุงุณุชุฎุฏุงู Firebase
        phones = await window.storage.getPhones();
        accessories = await window.storage.getAccessories();
        sales = await window.storage.getSales();
      } else {
        // ุงุณุชุฎุฏุงู LocalStorage ูุจุฏูู
        phones = JSON.parse(localStorage.getItem('phones') || '[]');
        accessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        sales = JSON.parse(localStorage.getItem('sales') || '[]');
      }

      // ุชุตููุฉ ุงูููุงุชู ุงููุจุงุนุฉ - ุฅุจูุงุก ุงูููุงุชู ุงููุชุงุญุฉ ููุท
      const availablePhones = phones.filter(phone => {
        const phoneId = phone.id || phone.phone_number;
        return phoneId && !isPhoneSold(phoneId, sales);
      });

      console.log('๐ฑ ุงูููุงุชู ุงููุชุงุญุฉ:', availablePhones.length, 'ูู ุฃุตู', phones.length);

      // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูููุงุชู (ุงูููุงุชู ุงููุชุงุญุฉ ููุท)
      const totalPhones = availablePhones.length;
      
      // ุญุณุงุจ ุงูููู ููููุงุชู ุงููุชุงุญุฉ ููุท
      const phonesPurchaseValue = availablePhones.reduce((sum, phone) => sum + (phone.purchase_price || 0), 0);
      const phonesSellingValue = availablePhones.reduce((sum, phone) => sum + (phone.selling_price || 0), 0);
      
      // ุญุณุงุจ ุงูููู ููุฃูุณุณูุงุฑุงุช ุงููุชุงุญุฉ (ุงููููุฉ > 0)
      const availableAccessories = accessories.filter(acc => (acc.quantity_in_stock || acc.quantity || 0) > 0);
      const accessoriesPurchaseValue = availableAccessories.reduce((sum, acc) => sum + (acc.purchase_price || 0) * (acc.quantity_in_stock || acc.quantity || 0), 0);
      const accessoriesSellingValue = availableAccessories.reduce((sum, acc) => sum + (acc.selling_price || 0) * (acc.quantity_in_stock || acc.quantity || 0), 0);
      
      // ุฅุฌูุงูู ุงูููู (ููุงุชู + ุฃูุณุณูุงุฑุงุช)
      const totalPurchaseValue = phonesPurchaseValue + accessoriesPurchaseValue;
      const totalSellingValue = phonesSellingValue + accessoriesSellingValue;
      const totalExpectedProfit = totalSellingValue - totalPurchaseValue;

      console.log('๐ฑ ุงูููุงุชู ุงููุชุงุญุฉ:', availablePhones.length, 'ูู ุฃุตู', phones.length);
      console.log('๐ฆ ุงูุฃูุณุณูุงุฑุงุช ุงููุชุงุญุฉ:', availableAccessories.length, 'ูู ุฃุตู', accessories.length);
      console.log('๐ฐ ูููุฉ ุดุฑุงุก ุงูููุงุชู:', phonesPurchaseValue);
      console.log('๐ฐ ูููุฉ ุดุฑุงุก ุงูุฃูุณุณูุงุฑุงุช:', accessoriesPurchaseValue);
      console.log('๐ฐ ุฅุฌูุงูู ุงููููุฉ ุงูุดุฑุงุฆูุฉ:', totalPurchaseValue);

      document.getElementById('total_phones').textContent = convertToLatinNumbers(totalPhones);
      document.getElementById('total_purchase_value').textContent = convertToLatinNumbers(totalPurchaseValue.toFixed(2)) + ' ุฑูุงู';
      document.getElementById('total_selling_value').textContent = convertToLatinNumbers(totalSellingValue.toFixed(2)) + ' ุฑูุงู';
      document.getElementById('total_expected_profit').textContent = convertToLatinNumbers(totalExpectedProfit.toFixed(2)) + ' ุฑูุงู';


      // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุจูุนุงุช (ุงุณุชุซูุงุก ุงููุจูุนุงุช ุงููุณุชุฑุฌุนุฉ)
      let effectiveSales = (sales || []).filter(s => s && s.returned !== true && s.status !== 'ูุณุชุฑุฌุนุฉ');
      
      // ุชุตููุฉ ุงููุจูุนุงุช ุญุณุจ ุงููุชุฑุฉ ุงูุฒูููุฉ ุงููุญุฏุฏุฉ
      const { startDate, endDate } = getDateRange();
      effectiveSales = filterSalesByDateRange(effectiveSales, startDate, endDate);
      
      // ุชุญุฏูุซ ูุคุดุฑ ุงููุชุฑุฉ
      updatePeriodIndicator();
      
      const totalSales = effectiveSales.length;
      const totalSalesAmount = effectiveSales.reduce((sum, sale) => sum + (sale.total_amount || 0), 0);

      // ุญุณุงุจ ุงูุฑุจุญ ุงููุนูู: ุณุนุฑ ุงูุจูุน - ุณุนุฑ ุงูุดุฑุงุก
      let totalActualProfit = 0;
      let totalPurchaseCost = 0;
      
      effectiveSales.forEach(sale => {
        if (sale.items && Array.isArray(sale.items)) {
          sale.items.forEach(item => {
            // ุณุนุฑ ุงูุจูุน (ูู ุงููุจูุนุงุช)
            const sellingPrice = item.unitPrice || item.unit_price || 0;                                                                            
            const quantity = item.quantity || 1;
            const totalSellingPrice = sellingPrice * quantity;                                                                              
            
            // ุณุนุฑ ุงูุดุฑุงุก (ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)
            let purchasePrice = 0;
            if (item.type === 'phone') {
              const phone = phones.find(p => (p.id === item.id || p.phone_id === item.id || p.phone_number === item.id));
              if (phone) {
                purchasePrice = (phone.purchase_price || 0);
              }
            } else {
              const accessory = accessories.find(a => (a.id === item.id || a.sku === item.id));
              if (accessory) {
                purchasePrice = (accessory.purchase_price || 0);
              }
            }
            
            const totalPurchasePrice = purchasePrice * quantity;
            const itemProfit = totalSellingPrice - totalPurchasePrice;
            
            totalActualProfit += itemProfit;
            totalPurchaseCost += totalPurchasePrice;
          });
        }
      });

      // ุฌูุจ ุฃุฑุจุงุญ ุงูุตูุงูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุตููุชูุง ุญุณุจ ุงููุชุฑุฉ
      let maintenanceProfit = 0;
      let maintenanceJobs = [];
      try {
        console.log('๐ ุฌูุจ ุฃุฑุจุงุญ ุงูุตูุงูุฉ...');
        const allMaintenanceJobs = await window.firebaseDatabase.getMaintenanceJobs({ status: 'done' });
        console.log('๐ ุชู ุฌูุจ ุฃุนูุงู ุงูุตูุงูุฉ:', allMaintenanceJobs.length, 'ุนูู');
        
        // ุชุตููุฉ ุฃุนูุงู ุงูุตูุงูุฉ ุญุณุจ ุงููุชุฑุฉ ุงูุฒูููุฉ
        maintenanceJobs = allMaintenanceJobs.filter(job => {
          const jobDate = normalizeToDate(job.dateCompleted || job.date_completed || job.createdAt || job.created_at);
          if (!jobDate) return false;
          return jobDate >= startDate && jobDate <= endDate;
        });
        
        maintenanceProfit = maintenanceJobs.reduce((sum, job) => {
          const shopProfit = job.shopProfit || 0;
          console.log(`๐ง ุฃุฑุจุงุญ ุงูุตูุงูุฉ: ${job.customerName} = ${shopProfit} ุฑูุงู`);
          return sum + shopProfit;
        }, 0);
        
        console.log('๐ง ุฅุฌูุงูู ุฃุฑุจุงุญ ุงูุตูุงูุฉ ูููุชุฑุฉ:', maintenanceProfit, 'ุฑูุงู');
      } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฌูุจ ุฃุฑุจุงุญ ุงูุตูุงูุฉ:', error);
        maintenanceProfit = 0;
        maintenanceJobs = [];
      }

      // ุฅุถุงูุฉ ุฃุฑุจุงุญ ุงูุตูุงูุฉ ุฅูู ุงูุฑุจุญ ุงููุนูู
      totalActualProfit += maintenanceProfit;
      console.log('๐ฐ ุฑุจุญ ุงููุจูุนุงุช:', totalActualProfit - maintenanceProfit);
      console.log('๐ฐ ุฃุฑุจุงุญ ุงูุตูุงูุฉ:', maintenanceProfit);
      console.log('๐ฐ ุฅุฌูุงูู ุงูุฑุจุญ ุงููุนูู (ูุจูุนุงุช + ุตูุงูุฉ):', totalActualProfit);

      // ุญุณุงุจ ูุณุจุฉ ุงูุฑุจุญ ุงููุนููุฉ (ุงูุฑุจุญ ุงููุนูู รท ุฅุฌูุงูู ุงููุจูุนุงุช)
      const salesProfit = totalActualProfit - maintenanceProfit;
      const actualProfitRatio = totalSalesAmount > 0 ? (totalActualProfit / totalSalesAmount) * 100 : 0;
      
      // ุญุณุงุจ ูุณุจุฉ ุงูุฑุจุญ ุงูุฅุฌูุงููุฉ (ูุจูุนุงุช + ุตูุงูุฉ)
      const maintenanceRevenue = maintenanceJobs ? maintenanceJobs.reduce((sum, job) => sum + (job.amountCharged || 0), 0) : 0;
      const totalRevenue = totalSalesAmount + maintenanceRevenue;
      const totalProfitRatio = totalRevenue > 0 ? (totalActualProfit / totalRevenue) * 100 : 0;

      console.log('๐ฐ ุฅุฌูุงูู ุณุนุฑ ุงูุจูุน:', totalSalesAmount);
      console.log('๐ฐ ุฅุฌูุงูู ุณุนุฑ ุงูุดุฑุงุก:', totalPurchaseCost);
      console.log('๐ฐ ุฑุจุญ ุงููุจูุนุงุช ููุท:', salesProfit);
      console.log('๐ฐ ุฅุฌูุงูู ุงูุฑุจุญ ุงููุนูู (ูุจูุนุงุช + ุตูุงูุฉ):', totalActualProfit);
      console.log('๐ฐ ูุณุจุฉ ุงูุฑุจุญ ุงููุนููุฉ (ุงูุฑุจุญ รท ุงููุจูุนุงุช):', actualProfitRatio.toFixed(2) + '%');
      console.log('๐ฐ ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช (ูุจูุนุงุช + ุตูุงูุฉ):', totalRevenue);
      console.log('๐ฐ ูุณุจุฉ ุงูุฑุจุญ ุงูุฅุฌูุงููุฉ:', totalProfitRatio.toFixed(2) + '%');

      document.getElementById('total_sales_count').textContent = convertToLatinNumbers(totalSales);                                                         
      document.getElementById('total_sales_amount').textContent = convertToLatinNumbers(totalSalesAmount.toFixed(0));                                       
      document.getElementById('total_actual_profit').textContent = convertToLatinNumbers(totalActualProfit.toFixed(2));
      
      // ุชุญุฏูุซ ุฅุฌูุงูู ุงููุจูุนุงุช ูููุชุฑุฉ ุงููุญุฏุฏุฉ
      const totalSalesAmountElement = document.getElementById('total_sales_amount_period');
      if (totalSalesAmountElement) {
        totalSalesAmountElement.textContent = convertToLatinNumbers(totalSalesAmount.toFixed(0)) + ' ุฑูุงู';
      }

      // ุญุณุงุจ ูุณุจุฉ ุงูุฑุจุญ
      document.getElementById('profit_ratio').textContent = convertToLatinNumbers(actualProfitRatio.toFixed(1)) + '%';

      // ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ ููุชุดุฎูุต
      console.log('๐ฐ ุฑุจุญ ุงููุจูุนุงุช:', salesProfit);
      console.log('๐ฐ ุฃุฑุจุงุญ ุงูุตูุงูุฉ:', maintenanceProfit);
      console.log('๐ฐ ุฅุฌูุงูู ุงูุฑุจุญ ุงููุนูู:', totalActualProfit);
      console.log('๐ฐ ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช:', totalSalesAmount);
      console.log('๐ฐ ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช:', totalRevenue);
      console.log('๐ฐ ูุณุจุฉ ุงูุฑุจุญ ุงููุนููุฉ (ุงูุฑุจุญ รท ุงููุจูุนุงุช):', actualProfitRatio.toFixed(2) + '%');
      console.log('๐ฐ ูุณุจุฉ ุงูุฑุจุญ ุงูุฅุฌูุงููุฉ:', totalProfitRatio.toFixed(2) + '%');

      // ุชุญุฏูุซ ุขุฎุฑ ุงููุจูุนุงุช (ุนุฑุถ ุขุฎุฑ 5 ูุจูุนุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ)
      updateRecentSales(effectiveSales);

    } catch (error) {
      console.error('ุฎุทุฃ ูู ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู:', error);
    }
  }

  // ุชุญุฏูุซ ูุณู ุขุฎุฑ ุงููุจูุนุงุช
  function updateRecentSales(sales) {
    const recentSalesContainer = document.getElementById('recent_sales_wrap');
    
    if (!sales || sales.length === 0) {
      recentSalesContainer.innerHTML = `
        <div class="text-center py-4">
          <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">ูุง ุชูุฌุฏ ูุจูุนุงุช ุญุฏูุซุฉ</h5>
        </div>
      `;
      return;
    }

    // ุชุฑุชูุจ ุงููุจูุนุงุช ุญุณุจ ุงูุชุงุฑูุฎ (ุงูุฃุญุฏุซ ุฃููุงู) ูุงุฎุชูุงุฑ ุขุฎุฑ 5
    const sortedSales = sales
      .sort((a, b) => {
        const dateA = getSaleDateValue(a) || new Date(0);
        const dateB = getSaleDateValue(b) || new Date(0);
        return dateB - dateA;
      })
      .slice(0, 5);

    let salesHTML = '';
    
    sortedSales.forEach(sale => {
      const saleDate = getSaleDateValue(sale) || new Date();
      const formattedDate = formatDate(saleDate);
      const customerName = sale.customer_name || 'ุนููู ููุฏู';
      const totalAmount = sale.total_amount || 0;
      const itemCount = sale.items ? sale.items.length : 0;
      const status = sale.status || 'ููุชูู';
      
      // ุชุญุฏูุฏ ููู ุงูุญุงูุฉ
      let statusBadge = 'bg-warning';
      if (status === 'ููุชูู') statusBadge = 'bg-success';
      else if (status === 'ููุบู') statusBadge = 'bg-danger';

      salesHTML += `
        <div class="row align-items-center py-2 border-bottom">
          <div class="col-md-2">
            <span class="badge bg-primary">${sale.sale_number || sale.id || 'ุบูุฑ ูุญุฏุฏ'}</span>
          </div>
          <div class="col-md-2">
            <small class="text-muted">${formattedDate}</small>
          </div>
          <div class="col-md-3">
            <strong>${customerName}</strong>
          </div>
          <div class="col-md-2">
            <span class="badge bg-info">${convertToLatinNumbers(itemCount)} ููุชุฌ</span>
          </div>
          <div class="col-md-2">
            <strong class="text-success">${convertToLatinNumbers(totalAmount.toFixed(2))} ุฑูุงู</strong>
          </div>
          <div class="col-md-1">
            <span class="badge ${statusBadge}">${status}</span>
          </div>
        </div>
      `;
    });

    recentSalesContainer.innerHTML = `
      <div class="table-responsive">
        <div class="row fw-bold text-muted border-bottom pb-2 mb-2">
          <div class="col-md-2">ุฑูู ุงูุนูููุฉ</div>
          <div class="col-md-2">ุงูุชุงุฑูุฎ</div>
          <div class="col-md-3">ุงูุนููู</div>
          <div class="col-md-2">ุงูููุชุฌุงุช</div>
          <div class="col-md-2">ุงููุจูุบ</div>
          <div class="col-md-1">ุงูุญุงูุฉ</div>
        </div>
        ${salesHTML}
      </div>
      <div class="text-center mt-3">
        <a href="list_sales.html" class="btn btn-outline-success">
          <i class="fas fa-list"></i> ุนุฑุถ ุฌููุน ุงููุจูุนุงุช
        </a>
      </div>
    `;
  }

  // ุชูุณูู ุงูุชุงุฑูุฎ ููุนุฑุถ
  function formatDate(anyDate) {
    const d = normalizeToDate(anyDate);
    if (!d) return '-';
    
    try {
      const pad = x => String(x).padStart(2,'0');
      const year    = d.getFullYear();
      const month   = pad(d.getMonth() + 1);
      const day     = pad(d.getDate());
      const hours   = pad(d.getHours());
      const minutes = pad(d.getMinutes());
      
      return `${convertToLatinNumbers(year)}-${convertToLatinNumbers(month)}-${convertToLatinNumbers(day)} ${convertToLatinNumbers(hours)}:${convertToLatinNumbers(minutes)}`;
    } catch {
      return '-';
    }
  }

  // ุชููุฆุฉ ุงูุตูุญุฉ
  document.addEventListener('DOMContentLoaded', async function() {
    // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู
    if (!checkLogin()) return;

    // ุชููุฆุฉ ุงูุชูุงุฑูุฎ ุฅูู ุงูุดูุฑ ุงูุญุงูู
    initializeDateRange();

    // ุงูุชุธุงุฑ ุชุญููู Firebase
    await new Promise(resolve => setTimeout(resolve, 1000));

    // ุชุญุฏูุซ ููุญุฉ ุงูุชุญูู
    await updateDashboard();

    // ุชุญุฏูุซ ุงูุจูุงูุงุช ูู 10 ุซูุงูู
    setInterval(async () => {
      await updateDashboard();
    }, 10000);
  });
</script>

<!-- Navigation Script -->
<script src="js/navigation.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    initNavigation('dashboard');
  });
</script>
</body>
</html>
