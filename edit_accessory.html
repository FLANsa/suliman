<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تعديل الأكسسوار — أسطورة الذهبي</title>

  <!-- نفس الخط/المكتبات المستخدمة في القالب -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #2c3e50; border-color: #2c3e50; }
    .btn-primary:hover { background-color: #1a252f; border-color: #1a252f; }
  </style>
</head>
<body>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-edit"></i> تعديل الأكسسوار</h2>
    <div>
      <a href="list_accessories_simple.html" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> العودة لقائمة الأكسسوارات
      </a>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <!-- كان: تعديل: {{ accessory.name }} -->
      <h5 class="mb-0">تعديل: <span id="accessory_title">—</span></h5>
    </div>
    <div class="card-body">
      <!-- واجهة فقط: لا إرسال للخادم -->
      <form method="POST" action="#" onsubmit="return false;">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="name" class="form-label">اسم الأكسسوار</label>
              <input type="text" class="form-control" id="name" name="name" value="" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="category" class="form-label">الفئة</label>
              <div class="input-group">
                <select class="form-select" id="category" name="category" required>
                  <option value="">اختر الفئة</option>
                  <!-- ستُملأ لاحقًا من categoriesData -->
                </select>
                <button class="btn btn-outline-success" type="button" onclick="addAccessoryCategory()">
                  <i class="fas fa-plus"></i> إضافة
                </button>
                <button class="btn btn-outline-danger" type="button" onclick="deleteAccessoryCategory()">
                  <i class="fas fa-trash"></i> حذف
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label for="description" class="form-label">الوصف</label>
          <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>

        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label for="purchase_price" class="form-label">سعر الشراء (مع الضريبة)</label>
              <input type="number" step="0.01" class="form-control" id="purchase_price" name="purchase_price" value="" required>
              <small class="text-muted">السعر المدخل هو السعر مع الضريبة (15%)</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label for="selling_price" class="form-label">سعر البيع (مع الضريبة)</label>
              <input type="number" step="0.01" class="form-control" id="selling_price" name="selling_price" value="" required>
              <small class="text-muted">السعر المدخل هو السعر مع الضريبة (15%)</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label for="quantity" class="form-label">الكمية في المخزون</label>
              <input type="number" class="form-control" id="quantity" name="quantity" value="0" required min="0">
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="supplier" class="form-label">المورد</label>
              <input type="text" class="form-control" id="supplier" name="supplier" value="">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label for="notes" class="form-label">ملاحظات</label>
          <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
        </div>

        <div class="d-flex justify-content-between">
          <button type="submit" class="btn btn-primary" onclick="saveAccessory()">
            <i class="fas fa-save"></i> حفظ التعديلات
          </button>
          <a href="list_accessories_simple.html" class="btn btn-secondary">
            <i class="fas fa-times"></i> إلغاء
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- مكتبات JS نفسها -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Firebase Integration -->
  <script type="module" src="js/firebase-config-cdn.js"></script>
  <script type="module" src="js/firebase-database-cdn.js"></script>
  <script type="module" src="js/firebase-storage-manager.js"></script>

<!-- سكربتات Firebase Integration -->
<script>
  // تهيئة Firebase عند تحميل الصفحة
  document.addEventListener('DOMContentLoaded', async () => {
    // انتظار تهيئة Firebase
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (window.storage && window.storage.isFirebaseAvailable) {
      console.log('✅ Firebase متاح في صفحة التعديل');
      await loadCategories();
    } else {
      console.log('⚠️ Firebase غير متاح، استخدام البيانات المحلية');
      populateCategories();
    }
  });

  // تحميل الفئات من Firebase
  async function loadCategories() {
    try {
      if (window.storage && window.storage.isFirebaseAvailable) {
        const categories = await window.storage.getAccessoryCategories();
        if (categories && categories.length > 0) {
          const select = document.getElementById('category');
          select.innerHTML = '<option value="">اختر الفئة</option>';
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.arabic_name;
            select.appendChild(option);
          });
          console.log('✅ تم تحميل الفئات من Firebase');
        }
      }
    } catch (error) {
      console.error('❌ خطأ في تحميل الفئات:', error);
      populateCategories(); // استخدام البيانات المحلية كبديل
    }
  }

  // بيانات واجهة محلية (بديل في حالة عدم توفر Firebase)
  const categoriesData = [
    { name: "case", arabic_name: "أغلفة" },
    { name: "charger", arabic_name: "شواحن" },
    { name: "screen_protector", arabic_name: "حماية الشاشة" }
  ];

  // محاكاة عنصر أكسسوار جاري تعديله (بدل accessory من السيرفر)
  const currentAccessory = {
    name: "غطاء شفاف",
    category: "case",
    arabic_category: "أغلفة",
    description: "سيليكون مرن",
    purchase_price: 28.75, // مع الضريبة
    selling_price: 51.75,  // مع الضريبة
    quantity_in_stock: 20,
    supplier: "XYZ للتوريد",
    notes: ""
  };

  function fillFormFromAccessory() {
    document.getElementById('accessory_title').textContent = currentAccessory.name || "—";
    document.getElementById('name').value = currentAccessory.name || "";
    populateCategories();
    document.getElementById('category').value = currentAccessory.category || "";
    document.getElementById('description').value = currentAccessory.description || "";
    document.getElementById('purchase_price').value = currentAccessory.purchase_price || "";
    document.getElementById('selling_price').value = currentAccessory.selling_price || "";
    document.getElementById('quantity').value = currentAccessory.quantity_in_stock ?? 0;
    document.getElementById('supplier').value = currentAccessory.supplier || "";
    document.getElementById('notes').value = currentAccessory.notes || "";
  }

  function populateCategories() {
    const sel = document.getElementById('category');
    sel.innerHTML = '<option value="">اختر الفئة</option>';
    categoriesData.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat.name;
      opt.textContent = cat.arabic_name;
      sel.appendChild(opt);
    });
  }

  // نفس سلوك الصفحة الأصلية: حساب السعر قبل الضريبة بالـ console
  document.addEventListener('DOMContentLoaded', () => {
    fillFormFromAccessory();

    document.getElementById('purchase_price').addEventListener('input', function () {
      const priceWithVAT = parseFloat(this.value) || 0;
      const priceWithoutVAT = priceWithVAT / 1.15;
      console.log('Purchase price without VAT:', priceWithoutVAT.toFixed(2));
    });

    document.getElementById('selling_price').addEventListener('input', function () {
      const priceWithVAT = parseFloat(this.value) || 0;
      const priceWithoutVAT = priceWithVAT / 1.15;
      console.log('Selling price without VAT:', priceWithoutVAT.toFixed(2));
    });
  });

  // بدائل محلية لعمليات إضافة/حذف/تحديث الفئات (بدون خادم)
  function addAccessoryCategory() {
    const categoryName = prompt('أدخل اسم الفئة الإنجليزية (المفتاح):');
    if (!categoryName || !categoryName.trim()) return;
    const arabicName = prompt('أدخل الاسم العربي للفئة:') || categoryName;
    categoriesData.push({ name: categoryName.trim(), arabic_name: arabicName.trim() });
    populateCategories();
    document.getElementById('category').value = categoryName.trim();
    alert('تمت إضافة الفئة (واجهة فقط).');
  }

  function deleteAccessoryCategory() {
    const sel = document.getElementById('category');
    const selected = sel.value;
    if (!selected) { alert('يرجى اختيار فئة'); return; }
    if (!confirm(`هل أنت متأكد من حذف فئة:\n\n${selected}\n\nهذا الإجراء لا يمكن التراجع عنه!`)) return;
    const idx = categoriesData.findIndex(c => c.name === selected);
    if (idx >= 0) categoriesData.splice(idx, 1);
    populateCategories();
    alert('تم الحذف (واجهة فقط).');
  }

  async function saveAccessory() {
    try {
      const payload = {
        name: document.getElementById('name').value.trim(),
        arabic_name: document.getElementById('name').value.trim(),
        category: document.getElementById('category').value,
        description: document.getElementById('description').value.trim(),
        purchase_price: parseFloat(document.getElementById('purchase_price').value) || 0,
        selling_price: parseFloat(document.getElementById('selling_price').value) || 0,
        quantity: parseInt(document.getElementById('quantity').value) || 0,
        supplier: document.getElementById('supplier').value.trim(),
        notes: document.getElementById('notes').value.trim(),
        date_updated: new Date().toISOString()
      };

      // التحقق من البيانات المطلوبة
      if (!payload.name) {
        alert('يرجى إدخال اسم الأكسسوار');
        return;
      }

      if (!payload.category) {
        alert('يرجى اختيار الفئة');
        return;
      }

      if (payload.purchase_price <= 0) {
        alert('يرجى إدخال سعر شراء صحيح');
        return;
      }

      if (payload.selling_price <= 0) {
        alert('يرجى إدخال سعر بيع صحيح');
        return;
      }

      if (payload.quantity < 0) {
        alert('يرجى إدخال كمية صحيحة');
        return;
      }

      // حفظ في Firebase
      if (window.storage && window.storage.isFirebaseAvailable) {
        const accessoryId = await window.storage.updateAccessory(payload);
        if (accessoryId) {
          console.log('✅ تم تحديث الأكسسوار في Firebase:', accessoryId);
          alert('تم تحديث الأكسسوار بنجاح!');
          // إعادة توجيه إلى صفحة قائمة الأكسسوارات
          window.location.href = 'list_accessories_simple.html';
        }
      } else {
        alert('Firebase غير متاح. تأكد من الاتصال بالإنترنت.');
      }
    } catch (error) {
      console.error('❌ خطأ في تحديث الأكسسوار:', error);
      alert('حدث خطأ في تحديث الأكسسوار');
    }
  }
</script>
</body>
</html>
