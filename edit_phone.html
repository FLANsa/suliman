<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2c3e50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ â€” Ù…Ù‡Ù†Ø¯ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { background-color: #2c3e50; position: fixed; top: 0; width: 100%; z-index: 1030; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar-brand, .nav-link { color: white !important; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #2c3e50; border-color: #2c3e50; }
    .btn-primary:hover { background-color: #1a252f; border-color: #1a252f; }
    .btn-success { background-color: #28a745; border-color: #28a745; }
    .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand">Ù…Ù‡Ù†Ø¯ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <!-- Navigation will be populated by navigation.js -->
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h2 class="mb-0">
              <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ
            </h2>
          </div>
          <div class="card-body">
            
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
              </div>
              <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ...</p>
            </div>

            <!-- Phone Not Found -->
            <div id="phoneNotFound" class="alert alert-warning d-none">
              <h4><i class="fas fa-exclamation-triangle"></i> Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ</h4>
              <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«.</p>
              <a href="search.html" class="btn btn-primary">
                <i class="fas fa-search"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
              </a>
            </div>

            <!-- Edit Form -->
            <form id="editPhoneForm" class="d-none">
              
              <!-- Basic Information -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5 class="text-primary border-bottom pb-2">
                    <i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                  </h5>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="phone_number" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
                  <input type="text" class="form-control" id="phone_number" readonly>
                  <div class="form-text">Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡</div>
                </div>
                <div class="col-md-4">
                  <label for="manufacturer" class="form-label">Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©</label>
                  <select class="form-select" id="manufacturer" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="model" class="form-label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                  <select class="form-select" id="model" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</option>
                  </select>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="phone_color" class="form-label">Ø§Ù„Ù„ÙˆÙ†</label>
                  <input type="text" class="form-control" id="phone_color">
                </div>
                <div class="col-md-4">
                  <label for="phone_memory" class="form-label">Ø§Ù„Ø°Ø§ÙƒØ±Ø©</label>
                  <select class="form-select" id="phone_memory">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©</option>
                    <option value="32GB">32GB</option>
                    <option value="64GB">64GB</option>
                    <option value="128GB">128GB</option>
                    <option value="256GB">256GB</option>
                    <option value="512GB">512GB</option>
                    <option value="1TB">1TB</option>
                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="serial_number" class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</label>
                  <input type="text" class="form-control" id="serial_number" required>
                </div>
              </div>

              <!-- Pricing Information -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5 class="text-success border-bottom pb-2">
                    <i class="fas fa-dollar-sign"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                  </h5>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="purchase_price" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="purchase_price" step="0.01" min="0" required>
                    <span class="input-group-text">Ø±ÙŠØ§Ù„</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <label for="selling_price" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="selling_price" step="0.01" min="0" required>
                    <span class="input-group-text">Ø±ÙŠØ§Ù„</span>
                  </div>
                </div>
              </div>

              <!-- Condition and Warranty -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5 class="text-info border-bottom pb-2">
                    <i class="fas fa-cog"></i> Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¶Ù…Ø§Ù†
                  </h5>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="condition" class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ù‡Ø§ØªÙ</label>
                  <select class="form-select" id="condition" required>
                    <option value="new">Ø¬Ø¯ÙŠØ¯</option>
                    <option value="used">Ù…Ø³ØªØ¹Ù…Ù„</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="warranty" class="form-label">ÙØªØ±Ø© Ø§Ù„Ø¶Ù…Ø§Ù†</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="warranty" min="0" max="24">
                    <span class="input-group-text">Ø´Ù‡Ø±</span>
                  </div>
                </div>
                <div class="col-md-4" id="batteryAgeField" style="display: none;">
                  <label for="battery_age" class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="battery_age" placeholder="Ù…Ø«Ø§Ù„: 85% Ø£Ùˆ Ø¬Ø¯ÙŠØ¯Ø©">
                  </div>
                </div>
              </div>

              <!-- Customer Information -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5 class="text-warning border-bottom pb-2">
                    <i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                  </h5>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="customer_name" class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input type="text" class="form-control" id="customer_name">
                </div>
                <div class="col-md-4">
                  <label for="customer_id" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</label>
                  <input type="text" class="form-control" id="customer_id" maxlength="10" pattern="[0-9]{10}">
                </div>
                <div class="col-md-4">
                  <label for="customer_phone" class="form-label">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input type="text" class="form-control" id="customer_phone" maxlength="10" pattern="[0-9]{10}">
                </div>
              </div>

              <!-- Additional Information -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5 class="text-secondary border-bottom pb-2">
                    <i class="fas fa-info"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                  </h5>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="buyer_name" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ</label>
                  <input type="text" class="form-control" id="buyer_name">
                </div>
                <div class="col-md-6">
                  <label for="description" class="form-label">Ø§Ù„ÙˆØµÙ</label>
                  <textarea class="form-control" id="description" rows="3"></textarea>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="row">
                <div class="col-12 text-center">
                  <button type="submit" class="btn btn-success btn-lg me-3">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                  </button>
                  <a href="search.html" class="btn btn-secondary btn-lg">
                    <i class="fas fa-arrow-right"></i> Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©
                  </a>
                </div>
              </div>

            </form>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Integration -->
  <script type="module" src="js/firebase-config-cdn.js"></script>
  <script type="module" src="js/firebase-database-cdn.js"></script>
  <script type="module" src="js/firebase-storage-manager.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let currentPhone = null;

    // ===== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ =====
    async function loadPhoneForEdit(phoneNumber) {
      try {
        console.log('ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:', phoneNumber);
        
        let phone = null;
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Firebase Ø£ÙˆÙ„Ø§Ù‹
        if (window.storage && window.storage.isFirebaseAvailable) {
          const phones = await window.storage.getPhones();
          phone = phones.find(p => p.phone_number === phoneNumber || p.id === phoneNumber);
        }
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ localStorage ÙƒØ¨Ø¯ÙŠÙ„
        if (!phone) {
          const phones = JSON.parse(localStorage.getItem('phones') || '[]');
          phone = phones.find(p => p.phone_number === phoneNumber || p.id === phoneNumber);
        }
        
        if (phone) {
          console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ:', phone);
          currentPhone = phone;
          
          // Ø¥Ø®ÙØ§Ø¡ spinner ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
          document.getElementById('loadingSpinner').classList.add('d-none');
          document.getElementById('editPhoneForm').classList.remove('d-none');
          
          // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          document.getElementById('phone_number').value = phone.phone_number || '';
          
          // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹
          const manufacturer = phone.manufacturer || phone.brand || '';
          document.getElementById('manufacturer').value = manufacturer;
          
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©
          if (manufacturer) {
            await loadModels(manufacturer);
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            document.getElementById('model').value = phone.model || '';
          }
          
          document.getElementById('phone_color').value = phone.phone_color || '';
          
          // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ÙŠØ§Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          const memoryValue = phone.phone_memory || phone.memory || '';
          const memorySelect = document.getElementById('phone_memory');
          if (memoryValue) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            const optionExists = Array.from(memorySelect.options).some(opt => opt.value === memoryValue);
            if (!optionExists && memoryValue !== '') {
              // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒØ®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
              const newOption = document.createElement('option');
              newOption.value = memoryValue;
              newOption.textContent = memoryValue;
              memorySelect.appendChild(newOption);
            }
            memorySelect.value = memoryValue;
          }
          
          document.getElementById('serial_number').value = phone.serial_number || '';
          document.getElementById('purchase_price').value = phone.purchase_price || '';
          document.getElementById('selling_price').value = phone.selling_price || phone.price || '';
          document.getElementById('condition').value = phone.condition || phone.phone_type || 'new';
          document.getElementById('warranty').value = phone.warranty || '';
          document.getElementById('customer_name').value = phone.customer_name || '';
          document.getElementById('customer_id').value = phone.customer_id || '';
          document.getElementById('customer_phone').value = phone.customer_phone || '';
          document.getElementById('buyer_name').value = phone.buyer_name || '';
          document.getElementById('description').value = phone.description || '';
          
          // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø¹Ù…Ø± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù‡Ø§ØªÙ
          toggleBatteryAgeField();
          
          // ØªØ¹ÙŠÙŠÙ† Ø¹Ù…Ø± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø©
          if (phone.condition === 'used' || phone.phone_type === 'used') {
            document.getElementById('battery_age').value = phone.age || phone.battery_level || '';
          }
          
        } else {
          console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ');
          document.getElementById('loadingSpinner').classList.add('d-none');
          document.getElementById('phoneNotFound').classList.remove('d-none');
        }
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ:', error);
        document.getElementById('loadingSpinner').classList.add('d-none');
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ');
      }
    }

    // ===== ØªØ¨Ø¯ÙŠÙ„ Ø­Ù‚Ù„ Ø¹Ù…Ø± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© =====
    function toggleBatteryAgeField() {
      const condition = document.getElementById('condition').value;
      const batteryAgeField = document.getElementById('batteryAgeField');
      
      if (condition === 'used') {
        batteryAgeField.style.display = 'block';
        document.getElementById('battery_age').required = true;
      } else {
        batteryAgeField.style.display = 'none';
        document.getElementById('battery_age').required = false;
        document.getElementById('battery_age').value = '';
      }
    }

    // ===== Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª =====
    async function savePhoneChanges() {
      try {
        if (!currentPhone) {
          showAlert('danger', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø§ØªÙ Ù„Ù„ØªØ­Ø±ÙŠØ±');
          return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const customerId = document.getElementById('customer_id').value.trim();
        const customerPhone = document.getElementById('customer_phone').value.trim();
        
        if (customerId && (customerId.length !== 10 || !/^[0-9]{10}$/.test(customerId))) {
          showAlert('warning', 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 10 Ø£Ø±Ù‚Ø§Ù…');
          document.getElementById('customer_id').focus();
          return false;
        }
        
        if (customerPhone && (customerPhone.length !== 10 || !/^[0-9]{10}$/.test(customerPhone))) {
          showAlert('warning', 'Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 10 Ø£Ø±Ù‚Ø§Ù…');
          document.getElementById('customer_phone').focus();
          return false;
        }

        const condition = document.getElementById('condition').value;
        if (condition === 'used') {
          const batteryValue = document.getElementById('battery_age').value.trim();
          if (!batteryValue) {
            showAlert('warning', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©');
            document.getElementById('battery_age').focus();
            return false;
          }
        }

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        const updatedPhoneData = {
          ...currentPhone,
          manufacturer: document.getElementById('manufacturer').value,
          brand: document.getElementById('manufacturer').value, // Ù„Ù„ØªÙˆØ§ÙÙ‚
          model: document.getElementById('model').value,
          phone_color: document.getElementById('phone_color').value,
          phone_memory: document.getElementById('phone_memory').value,
          memory: document.getElementById('phone_memory').value, // Ù„Ù„ØªÙˆØ§ÙÙ‚
          serial_number: document.getElementById('serial_number').value,
          purchase_price: parseFloat(document.getElementById('purchase_price').value) || 0,
          selling_price: parseFloat(document.getElementById('selling_price').value) || 0,
          price: parseFloat(document.getElementById('selling_price').value) || 0, // Ù„Ù„ØªÙˆØ§ÙÙ‚
          condition: condition,
          phone_type: condition, // Ù„Ù„ØªÙˆØ§ÙÙ‚
          warranty: parseInt(document.getElementById('warranty').value) || 0,
          customer_name: document.getElementById('customer_name').value,
          customer_id: document.getElementById('customer_id').value,
          customer_phone: document.getElementById('customer_phone').value,
          buyer_name: document.getElementById('buyer_name').value,
          description: document.getElementById('description').value,
          updatedAt: new Date().toISOString()
        };

        // Ø¥Ø¶Ø§ÙØ© Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø©
        if (condition === 'used') {
          const batteryValue = document.getElementById('battery_age').value.trim();
          updatedPhoneData.age = batteryValue;
          updatedPhoneData.battery_level = batteryValue;
        } else {
          updatedPhoneData.age = null;
          updatedPhoneData.battery_level = '100';
        }

        console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ:', updatedPhoneData);

        let savedOK = false;
        
        if (window.storage && window.storage.isFirebaseAvailable) {
          // ØªØ­Ø¯ÙŠØ« ÙÙŠ Firebase
          savedOK = await window.storage.updatePhone(currentPhone.id || currentPhone.phone_number, updatedPhoneData);
        } else {
          // ØªØ­Ø¯ÙŠØ« ÙÙŠ localStorage
          const arr = JSON.parse(localStorage.getItem('phones') || '[]');
          const index = arr.findIndex(p => p.id === currentPhone.id || p.phone_number === currentPhone.phone_number);
          if (index !== -1) {
            arr[index] = { ...arr[index], ...updatedPhoneData };
            localStorage.setItem('phones', JSON.stringify(arr));
            savedOK = true;
          }
        }
        
        if (savedOK) {
          showAlert('success', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ù†Ø¬Ø§Ø­!');
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ 2 Ø«Ø§Ù†ÙŠØ©
          setTimeout(() => {
            window.location.href = 'search.html';
          }, 2000);
          return true;
        } else {
          showAlert('danger', 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡Ø§ØªÙ');
          return false;
        }

      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
        return false;
      }
    }

    // ===== ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø© =====
    async function loadManufacturers() {
      try {
        console.log('ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø© Ù…Ù† Firebase...');
        
        if (window.storage && window.storage.isFirebaseAvailable) {
          const phoneTypes = await window.storage.getPhoneTypes();
          console.log('ğŸ“± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', phoneTypes);
          
          // phoneTypes is now an object with brand as keys
          const manufacturers = Object.keys(phoneTypes);
          console.log('ğŸ­ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©:', manufacturers);
          
          const select = document.getElementById('manufacturer');
          select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©</option>';
          manufacturers.forEach(manufacturer => {
            const option = document.createElement('option');
            option.value = manufacturer;
            option.textContent = manufacturer;
            select.appendChild(option);
          });
          
          console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
        } else {
          console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage...');
          const phoneTypes = JSON.parse(localStorage.getItem('phone_types') || '{}');
          const manufacturers = Object.keys(phoneTypes);
          
          const select = document.getElementById('manufacturer');
          select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©</option>';
          manufacturers.forEach(manufacturer => {
            const option = document.createElement('option');
            option.value = manufacturer;
            option.textContent = manufacturer;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©:', error);
        showAlert('warning', 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©');
      }
    }

    // ===== ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø© =====
    async function loadModels(manufacturer) {
      try {
        console.log('ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©:', manufacturer);
        
        if (!manufacturer) {
          document.getElementById('model').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</option>';
          return;
        }
        
        let phoneTypes = {};
        
        if (window.storage && window.storage.isFirebaseAvailable) {
          phoneTypes = await window.storage.getPhoneTypes();
        } else {
          phoneTypes = JSON.parse(localStorage.getItem('phone_types') || '{}');
        }
        
        // phoneTypes is now an object with brand as keys and models as arrays
        const models = phoneTypes[manufacturer] || [];
        
        console.log('ğŸ“± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', models);
        
        const modelSelect = document.getElementById('model');
        const currentModel = modelSelect.value;
        
        // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const shouldPreserveModel = models.includes(currentModel);
        
        modelSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</option>';
        models.forEach(model => {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          if (shouldPreserveModel && model === currentModel) {
            option.selected = true;
          }
          modelSelect.appendChild(option);
        });
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø£Ø¶ÙÙ‡
        if (currentModel && !shouldPreserveModel) {
          const option = document.createElement('option');
          option.value = currentModel;
          option.textContent = currentModel;
          option.selected = true;
          modelSelect.insertBefore(option, modelSelect.firstChild);
        }
        
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª:', error);
        showAlert('warning', 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª');
      }
    }

    // ===== Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª =====
    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // ===== ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯ =====
    function updateNavigationForUser() {
      const currentUser = localStorage.getItem('current_user');
      if (currentUser) {
        try {
          const userData = JSON.parse(currentUser);
          const navbar = document.querySelector('.navbar-nav.me-auto');
          
          if (userData.role === 'user' && navbar) {
            navbar.innerHTML = `
              <li class="nav-item"><a class="nav-link" href="limited_dashboard.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
              <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
            `;
          }
          // Admin users keep the full navigation (default)
        } catch (error) {
          console.error('Error parsing user data:', error);
        }
      }
    }

    // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
    function checkLogin() {
      const currentUser = localStorage.getItem('current_user');
      if (!currentUser) {
        alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        window.location.href = 'login.html';
        return false;
      }
      return true;
    }

    // ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ =====
    function logout() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        localStorage.removeItem('current_user');
        alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
        window.location.href = 'index.html';
      }
    }

    // ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© =====
    document.addEventListener('DOMContentLoaded', async function() {
      // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø­Ø³Ø¨ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      updateNavigationForUser();
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
      if (!checkLogin()) return;

      // Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      if (window.storage && window.storage.isFirebaseAvailable) {
        console.log('âœ… Firebase Ù…ØªØ§Ø­ ÙÙŠ ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ');
      } else {
        console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage');
      }

      // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØµÙ†Ø¹Ø©
      await loadManufacturers();

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ URL
      const urlParams = new URLSearchParams(window.location.search);
      const editPhoneNumber = urlParams.get('edit');
      
      if (editPhoneNumber) {
        await loadPhoneForEdit(editPhoneNumber);
      } else {
        document.getElementById('loadingSpinner').classList.add('d-none');
        document.getElementById('phoneNotFound').classList.remove('d-none');
      }

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù‡Ø§ØªÙ
      document.getElementById('condition').addEventListener('change', toggleBatteryAgeField);

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©
      document.getElementById('manufacturer').addEventListener('change', async function(e) {
        const selectedManufacturer = e.target.value;
        console.log('ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø© Ø¥Ù„Ù‰:', selectedManufacturer);
        await loadModels(selectedManufacturer);
      });

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
      document.getElementById('editPhoneForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await savePhoneChanges();
      });
    });
  </script>

  <!-- Navigation Script -->
  <script src="js/navigation.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      initNavigation('add_new_phone');
    });
  </script>
</body>
</html>
