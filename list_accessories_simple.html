<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2c3e50">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª â€” Ù…Ù‡Ù†Ø¯ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</title>

  <!-- Bootstrap & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #2c3e50; border-color: #2c3e50; }
    .btn-primary:hover { background-color: #1a252f; border-color: #1a252f; }
    .table thead.table-dark th { vertical-align: middle; }
    .profit-positive { color: #28a745; font-weight: bold; }
    .profit-negative { color: #dc3545; font-weight: bold; }
  </style>
</head>
<body>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
      <span class="navbar-brand">Ù…Ù‡Ù†Ø¯ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <!-- Navigation will be populated by navigation.js -->
        </ul>
      </div>
    </div>
  </nav>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="fas fa-box"></i> Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</h2>
      <div>
        <a href="add_accessory.html" class="btn btn-success me-2">
          <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¬Ø¯ÙŠØ¯
        </a>
        <a href="dashboard.html" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
      </div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body text-center">
            <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</h5>
            <h3 id="total-items">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body text-center">
            <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h5>
            <h3 id="total-quantity">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body text-center">
            <h5 class="card-title">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</h5>
            <h3 id="total-purchase-value">0.00 Ø±ÙŠØ§Ù„</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-white">
          <div class="card-body text-center">
            <h5 class="card-title">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙŠØ¹</h5>
            <h3 id="total-selling-value">0.00 Ø±ÙŠØ§Ù„</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª -->
    <div id="accessories-table" class="card">
      <div class="card-header">
        <h5 class="mb-0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ÙØ¦Ø©</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th>
                <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="accessories-tbody">
              <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div id="empty-state" class="card d-none">
      <div class="card-body text-center py-5">
        <i class="fas fa-box fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</h4>
        <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø¨Ø¹Ø¯</p>
        <a href="add_accessory.html" class="btn btn-success btn-lg">
          <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¬Ø¯ÙŠØ¯
        </a>
      </div>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Firebase Integration -->
  <script type="module" src="js/firebase-config-cdn.js"></script>
  <script type="module" src="js/firebase-database-cdn.js"></script>
  <script type="module" src="js/firebase-storage-manager.js"></script>

  <!-- Ù†Ø¸Ø§Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª -->
  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    
    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙØ¦Ø§Øª
    const categoryMap = {
      case: "Ø£ØºÙ„ÙØ©",
      charger: "Ø´ÙˆØ§Ø­Ù†", 
      screen_protector: "Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø©",
      cable: "ÙƒØ§Ø¨Ù„Ø§Øª",
      headphone: "Ø³Ù…Ø§Ø¹Ø§Øª",
      other: "Ø£Ø®Ø±Ù‰"
    };

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (ØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù† ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Firebase Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
  function convertArabicToEnglishNumbers(str) {
    const arabicNumbers = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
    const englishNumbers = '0123456789';
    
    let result = str.toString();
    for (let i = 0; i < arabicNumbers.length; i++) {
      result = result.replace(new RegExp(arabicNumbers[i], 'g'), englishNumbers[i]);
    }
    return result;
  }

  // ØªØ­ÙˆÙŠÙ„ Ù‚ÙŠÙ…Ø© ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø±Ù‚Ù… ØµØ­ÙŠØ­
  function parseArabicNumber(value) {
    if (!value) return 0;
    const convertedValue = convertArabicToEnglishNumbers(value);
    return parseFloat(convertedValue) || 0;
  }

  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©
  function formatMoney(amount) {
    return (Number(amount) || 0).toFixed(2);
  }

    // ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† ØªØ§Ø±ÙŠØ® ØµØ§Ù„Ø­ (ÙŠØ¯Ø¹Ù… Firestore Timestamp Ùˆ ISO ÙˆØºÙŠØ±Ù‡Ø§)
    function normalizeToDate(v) {
      if (v == null) return null;
      if (v instanceof Date) return isNaN(v.getTime()) ? null : v;
      if (typeof v === 'object') {
        if (typeof v.toDate === 'function') {
          const d = v.toDate();
          return isNaN(d?.getTime()) ? null : d;
        }
        if ('seconds' in v || '_seconds' in v) {
          const sec  = Number(v.seconds ?? v._seconds ?? 0);
          const nsec = Number(v.nanoseconds ?? v._nanoseconds ?? 0);
          const ms = (sec * 1000) + Math.floor(nsec / 1e6);
          const d = new Date(ms);
          return isNaN(d.getTime()) ? null : d;
        }
      }
      if (typeof v === 'number') {
        const ms = v > 1e12 ? v : v * 1000;
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }
      if (typeof v === 'string') {
        const s = v.trim();
        if (/^\d+$/.test(s)) {
          const n = parseInt(s, 10);
          const ms = n > 1e12 ? n : n * 1000;
          const d = new Date(ms);
          return isNaN(d.getTime()) ? null : d;
        }
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
      }
      return null;
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø£Ø±Ù‚Ø§Ù… Ù„Ø§ØªÙŠÙ†ÙŠØ© Ø¯Ø§Ø¦Ù…Ù‹Ø§)
    function formatDate(value) {
      const d = normalizeToDate(value);
      if (!d) return '-';
      const pad = n => String(n).padStart(2, '0');
      const y = d.getFullYear();
      const m = pad(d.getMonth() + 1);
      const day = pad(d.getDate());
      return `${y}-${m}-${day}`; // YYYY-MM-DD
    }

    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Firebase
    async function loadAccessories() {
      try {
        console.log('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        
        let accessories = [];
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
        if (window.storage && window.storage.isFirebaseAvailable) {
          console.log('ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase...');
          accessories = await window.storage.getAccessories();
          console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Firebase:', accessories.length);
        } else {
          console.log('âŒ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
          showAlert('danger', 'Firebase ØºÙŠØ± Ù…ØªØ§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
          return;
        }
        
        if (accessories.length === 0) {
          document.getElementById('accessories-table').classList.add('d-none');
          document.getElementById('empty-state').classList.remove('d-none');
          updateStatistics([]);
          return;
        }

        document.getElementById('accessories-table').classList.remove('d-none');
        document.getElementById('empty-state').classList.add('d-none');

        const tbody = document.getElementById('accessories-tbody');
        tbody.innerHTML = '';

        accessories.forEach((accessory, index) => {
          const profit = (accessory.selling_price || 0) - (accessory.purchase_price || 0);
          const profitPercentage = accessory.purchase_price > 0 ? 
            ((profit / accessory.purchase_price) * 100) : 0;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <strong>${accessory.arabic_name || accessory.name}</strong>
              ${accessory.description ? `<br><small class="text-muted">${accessory.description}</small>` : ''}
            </td>
            <td>
              <span class="badge bg-primary">${categoryMap[accessory.category] || accessory.category}</span>
            </td>
            <td>
              <span class="badge bg-success">${accessory.quantity_in_stock || accessory.quantity || 0}</span>
            </td>
            <td>
              ${formatMoney(accessory.purchase_price)} Ø±ÙŠØ§Ù„
            </td>
            <td>
              ${formatMoney(accessory.selling_price)} Ø±ÙŠØ§Ù„
            </td>
            <td>
              <span class="${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                ${formatMoney(profit)} Ø±ÙŠØ§Ù„
              </span>
              <br><small class="text-muted">${profitPercentage.toFixed(1)}%</small>
            </td>
            <td>${accessory.supplier || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
            <td>${formatDate(accessory.date_added || accessory.createdAt)}</td>
            <td>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editAccessory('${accessory.id || index}')" title="ØªØ¹Ø¯ÙŠÙ„">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAccessory('${accessory.id || index}')" title="Ø­Ø°Ù">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          
          tbody.appendChild(row);
        });

        updateStatistics(accessories);
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª');
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function updateStatistics(accessories) {
      console.log('ğŸ“Š Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
      
      const totalItems = accessories.length;
      const totalQuantity = accessories.reduce((sum, acc) => sum + (acc.quantity_in_stock || acc.quantity || 0), 0);
      const totalPurchaseValue = accessories.reduce((sum, acc) => 
        sum + ((acc.purchase_price || 0) * (acc.quantity_in_stock || acc.quantity || 0)), 0);
      const totalSellingValue = accessories.reduce((sum, acc) => 
        sum + ((acc.selling_price || 0) * (acc.quantity_in_stock || acc.quantity || 0)), 0);

      console.log('ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©:', {
        totalItems,
        totalQuantity,
        totalPurchaseValue,
        totalSellingValue
      });

      document.getElementById('total-items').textContent = totalItems;
      document.getElementById('total-quantity').textContent = totalQuantity;
      document.getElementById('total-purchase-value').textContent = formatMoney(totalPurchaseValue) + ' Ø±ÙŠØ§Ù„';
      document.getElementById('total-selling-value').textContent = formatMoney(totalSellingValue) + ' Ø±ÙŠØ§Ù„';
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø£ÙƒØ³Ø³ÙˆØ§Ø±
    async function editAccessory(accessoryId) {
      try {
        console.log('âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±:', accessoryId);
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Firebase
        if (!window.storage || !window.storage.isFirebaseAvailable) {
          showAlert('danger', 'Firebase ØºÙŠØ± Ù…ØªØ§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
          return;
        }
        
        const accessories = await window.storage.getAccessories();
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±
        const accessory = accessories.find(acc => acc.id === accessoryId || acc.id === parseInt(accessoryId));
        
        if (!accessory) {
          showAlert('danger', 'Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ·
        const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±:', accessory.arabic_name || accessory.name);
        if (newName === null) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡
        
        const newQuantity = prompt('Ø§Ù„ÙƒÙ…ÙŠØ©:', accessory.quantity_in_stock || accessory.quantity);
        if (newQuantity === null) return;
        
        const newPurchasePrice = prompt('Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:', accessory.purchase_price);
        if (newPurchasePrice === null) return;
        
        const newSellingPrice = prompt('Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:', accessory.selling_price);
        if (newSellingPrice === null) return;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!newName.trim()) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
          return;
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù‚Ù‚
        const convertedQuantity = parseArabicNumber(newQuantity);
        const convertedPurchasePrice = parseArabicNumber(newPurchasePrice);
        const convertedSellingPrice = parseArabicNumber(newSellingPrice);

        if (convertedQuantity < 0) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
          return;
        }

        if (convertedPurchasePrice <= 0) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡ ØµØ­ÙŠØ­');
          return;
        }

        if (convertedSellingPrice <= 0) {
          showAlert('danger', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹ ØµØ­ÙŠØ­');
          return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const updatedAccessory = {
          ...accessory,
          name: newName.trim(),
          arabic_name: newName.trim(),
          quantity_in_stock: convertedQuantity,
          quantity: convertedQuantity,
          purchase_price: convertedPurchasePrice,
          selling_price: convertedSellingPrice,
          date_updated: new Date().toISOString()
        };

        // Ø­ÙØ¸ ÙÙŠ Firebase Ø£Ùˆ localStorage
        if (window.storage && window.storage.isFirebaseAvailable) {
          const success = await window.storage.updateAccessory(accessoryId, updatedAccessory);
          if (success) {
            showAlert('success', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­');
            await loadAccessories();
          } else {
            showAlert('danger', 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
          }
        } else {
          const index = accessories.findIndex(acc => acc.id === accessoryId || acc.id === parseInt(accessoryId));
          if (index !== -1) {
            accessories[index] = updatedAccessory;
            if (saveToStorage('accessories', accessories)) {
              showAlert('success', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­');
              loadAccessories();
            } else {
              showAlert('danger', 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
            }
          }
        }
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
      }
    }

    // Ø­Ø°Ù Ø£ÙƒØ³Ø³ÙˆØ§Ø±
    async function deleteAccessory(accessoryId) {
      try {
        console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±:', accessoryId);
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Firebase
        if (!window.storage || !window.storage.isFirebaseAvailable) {
          showAlert('danger', 'Firebase ØºÙŠØ± Ù…ØªØ§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
          return;
        }
        
        const accessories = await window.storage.getAccessories();
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±
        const accessory = accessories.find(acc => acc.id === accessoryId || acc.id === parseInt(accessoryId));
        
        if (!accessory) {
          showAlert('danger', 'Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          return;
        }

        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${accessory.arabic_name || accessory.name}"ØŸ`)) return;

        // Ø­Ø°Ù Ù…Ù† Firebase Ø£Ùˆ localStorage
        if (window.storage && window.storage.isFirebaseAvailable) {
          const success = await window.storage.deleteAccessory(accessoryId);
          if (success) {
            showAlert('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­');
            await loadAccessories();
          } else {
            showAlert('danger', 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
          }
        } else {
          const index = accessories.findIndex(acc => acc.id === accessoryId || acc.id === parseInt(accessoryId));
          if (index !== -1) {
            accessories.splice(index, 1);
            if (saveToStorage('accessories', accessories)) {
              showAlert('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­');
              loadAccessories();
            } else {
              showAlert('danger', 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
            }
          }
        }
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
      }
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function exportData() {
      try {
        console.log('ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
        if (!window.storage || !window.storage.isFirebaseAvailable) {
          showAlert('danger', 'Firebase ØºÙŠØ± Ù…ØªØ§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
          return;
        }
        
        const accessories = await window.storage.getAccessories();
        
        if (accessories.length === 0) {
          showAlert('warning', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
          return;
        }

        const dataStr = JSON.stringify(accessories, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `accessories_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        showAlert('success', `ØªÙ… ØªØµØ¯ÙŠØ± ${accessories.length} Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­`);
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }
    }

    // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function clearAllData() {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§ØªØŸ\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) return;
      
      if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!')) return;

      try {
        console.log('ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
        
        if (!window.storage || !window.storage.isFirebaseAvailable) {
          showAlert('danger', 'Firebase ØºÙŠØ± Ù…ØªØ§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
          return;
        }
        
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† Firebase
        const accessories = await window.storage.getAccessories();
        for (const accessory of accessories) {
          await window.storage.deleteAccessory(accessory.id);
        }
        showAlert('success', `ØªÙ… Ù…Ø³Ø­ ${accessories.length} Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
        
        await loadAccessories();
        
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }
    }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  function logout() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
      localStorage.removeItem('current_user');
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
      window.location.href = 'index.html';
    }
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ù‚Ù„ Ø­Ø³Ø¨ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©/ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯)
  function updateNavigationForUser() {
    const currentUser = localStorage.getItem('current_user');
    if (!currentUser) return;
    try {
      const userData = JSON.parse(currentUser);
      if (userData && userData.role === 'user') {
        const navbar = document.querySelector('.navbar-nav.me-auto');
        if (navbar) {
          navbar.innerHTML = `
            <li class="nav-item"><a class="nav-link" href="limited_dashboard.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
          `;
        }
        const backBtn = document.querySelector('a.btn.btn-secondary[href="dashboard.html"]');
        if (backBtn) backBtn.setAttribute('href', 'limited_dashboard.html');
      }
    } catch (e) { /* ignore */ }
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', async function() {
    updateNavigationForUser();
    // Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (window.storage && window.storage.isFirebaseAvailable) {
      console.log('âœ… Firebase Ù…ØªØ§Ø­ ÙÙŠ ØµÙØ­Ø© Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª');
      await loadAccessories();
    } else {
      console.log('âŒ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„');
      showAlert('danger', 'Firebase ØºÙŠØ± Ù…ØªØ§Ø­ - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
      document.getElementById('accessories-table').classList.add('d-none');
      document.getElementById('empty-state').classList.remove('d-none');
      document.getElementById('empty-state').innerHTML = `
        <div class="text-center py-5">
          <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
          <h4 class="text-warning">Firebase ØºÙŠØ± Ù…ØªØ§Ø­</h4>
          <p class="text-muted">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</p>
          <button class="btn btn-primary" onclick="location.reload()">
            <i class="fas fa-refresh"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
          </button>
        </div>
      `;
    }
  });
  </script>

  <!-- Navigation Script -->
  <script src="js/navigation.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      initNavigation('list_accessories');
    });
  </script>

</body>
</html>
