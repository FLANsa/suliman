<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ‚Ø±ÙŠØ± Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© - Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠ</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Scripts -->
    <script type="module" src="js/firebase-config-cdn.js"></script>
    <script type="module" src="js/firebase-database-cdn.js"></script>
    
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .report-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
        }
        
        .report-header {
            text-align: center;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .report-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .report-header p {
            color: #6c757d;
            margin: 5px 0;
        }
        
        .filters-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filters-summary h5 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .filter-item {
            display: inline-block;
            background: #e9ecef;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 3px;
            font-size: 0.9em;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 0.85em;
        }
        
        .report-table th {
            background: #2c3e50;
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
        }
        
        .report-table td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }
        
        .report-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .parts-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .parts-list li {
            padding: 3px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .parts-list li:last-child {
            border-bottom: none;
        }
        
        .part-name {
            font-weight: 600;
        }
        
        .part-rep {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .part-cost {
            color: #28a745;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        
        .summary-section h4 {
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-item .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .summary-item .value {
            font-size: 1.4em;
            font-weight: 700;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-done {
            background: #d4edda;
            color: #155724;
        }
        
        .status-canceled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #6c757d;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 1.2rem;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.2rem;
        }
        
        .print-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .close-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        @media print {
            .print-btn, .close-btn {
                display: none !important;
            }
            
            body {
                padding: 0;
                margin: 0;
            }
            
            .report-container {
                max-width: 100%;
            }
            
            .report-table {
                font-size: 0.75em;
            }
            
            .summary-section {
                background: #2c3e50 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <!-- Print and Close Buttons -->
    <button class="btn btn-primary print-btn" onclick="window.print()">
        <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    </button>
    
    <button class="btn btn-secondary close-btn" onclick="window.close()">
        <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
    </button>

    <div class="report-container">
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±...
        </div>
        
        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i> Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </div>
        
        <div id="reportContent" style="display: none;">
            <!-- Report Header -->
            <div class="report-header">
                <h1><i class="fas fa-wrench"></i> ØªÙ‚Ø±ÙŠØ± Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</h1>
                <p>Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</p>
                <p id="reportDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <span></span></p>
            </div>
            
            <!-- Filters Summary -->
            <div class="filters-summary" id="filtersSummary">
                <h5><i class="fas fa-filter"></i> Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©:</h5>
                <div id="appliedFilters">
                    <!-- Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© Ø³ØªÙØ¶Ø§Ù Ù‡Ù†Ø§ -->
                </div>
            </div>
            
            <!-- Jobs Table -->
            <table class="report-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                        <th>Ø§Ù„Ù‚Ø·Ø¹ ÙˆØ§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</th>
                        <th>Ø§Ù„ÙÙ†ÙŠ</th>
                        <th>ØªÙƒÙ„ÙØ© Ø§Ù„Ù‚Ø·Ø¹</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„</th>
                        <th>Ø§Ù„Ø±Ø¨Ø­</th>
                        <th>Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ÙÙ†ÙŠ</th>
                        <th>Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­Ù„</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody id="jobsTableBody">
                    <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªÙØ¶Ø§Ù Ù‡Ù†Ø§ -->
                </tbody>
            </table>
            
            <!-- No Data Message -->
            <div id="noData" class="no-data" style="display: none;">
                <i class="fas fa-inbox"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            </div>
            
            <!-- Summary Section -->
            <div class="summary-section" id="summarySection">
                <h4><i class="fas fa-chart-bar"></i> Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                        <div class="value" id="totalJobs">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù‚Ø·Ø¹</div>
                        <div class="value" id="totalPartCost">0 Ø±ÙŠØ§Ù„</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø­ØµÙ„Ø©</div>
                        <div class="value" id="totalRevenue">0 Ø±ÙŠØ§Ù„</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
                        <div class="value" id="totalProfit">0 Ø±ÙŠØ§Ù„</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†</div>
                        <div class="value" id="totalTechCommission">0 Ø±ÙŠØ§Ù„</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­Ù„</div>
                        <div class="value" id="totalShopProfit">0 Ø±ÙŠØ§Ù„</div>
                    </div>
                </div>
            </div>
            
            <!-- Report Footer -->
            <div class="text-center mt-4 text-muted">
                <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠ</p>
                <p id="generatedAt"></p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let jobsData = [];
        let repsData = [];
        let techniciansData = [];
        let filters = {};

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Parse URL parameters
            parseFilters();
            
            // Wait for Firebase to initialize
            setTimeout(loadReportData, 1000);
        });

        // Parse filters from URL
        function parseFilters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            filters = {
                status: urlParams.get('status') || '',
                repId: urlParams.get('repId') || '',
                techId: urlParams.get('techId') || '',
                dateFrom: urlParams.get('dateFrom') || '',
                dateTo: urlParams.get('dateTo') || ''
            };
            
            console.log('ğŸ“Š Filters parsed:', filters);
        }

        // Load report data
        async function loadReportData() {
            try {
                console.log('ğŸ”„ Loading report data...');
                
                if (!window.firebaseDatabase) {
                    console.error('âŒ Firebase database not initialized');
                    showError('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
                    return;
                }

                // Load all required data
                [repsData, techniciansData] = await Promise.all([
                    window.firebaseDatabase.getReps(),
                    window.firebaseDatabase.getTechnicians()
                ]);

                // Build query filters
                const queryFilters = {};
                if (filters.status) queryFilters.status = filters.status;
                if (filters.techId) queryFilters.techId = filters.techId;
                if (filters.dateFrom) queryFilters.dateFrom = new Date(filters.dateFrom);
                if (filters.dateTo) {
                    const dateTo = new Date(filters.dateTo);
                    dateTo.setHours(23, 59, 59, 999);
                    queryFilters.dateTo = dateTo;
                }

                // Load jobs with filters
                jobsData = await window.firebaseDatabase.getMaintenanceJobs(queryFilters);
                
                // Filter by repId if specified (need to check in parts array)
                if (filters.repId) {
                    jobsData = jobsData.filter(job => {
                        if (job.repId === filters.repId) return true;
                        if (job.parts && Array.isArray(job.parts)) {
                            return job.parts.some(part => part.repId === filters.repId);
                        }
                        return false;
                    });
                }

                console.log('âœ… Data loaded:', {
                    jobs: jobsData.length,
                    reps: repsData.length,
                    technicians: techniciansData.length
                });

                // Display report
                displayReport();
                
            } catch (error) {
                console.error('âŒ Error loading report data:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            }
        }

        // Display the report
        function displayReport() {
            // Hide loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('reportContent').style.display = 'block';
            
            // Set report date
            document.querySelector('#reportDate span').textContent = new Date().toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Display applied filters
            displayFilters();
            
            // Check if there's data
            if (jobsData.length === 0) {
                document.getElementById('noData').style.display = 'block';
                document.getElementById('summarySection').style.display = 'none';
                return;
            }
            
            // Display jobs table
            displayJobsTable();
            
            // Display summary
            displaySummary();
            
            // Set generated time
            document.getElementById('generatedAt').textContent = 
                'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ: ' + new Date().toLocaleString('ar-SA');
        }

        // Display applied filters
        function displayFilters() {
            const container = document.getElementById('appliedFilters');
            let filtersHTML = '';
            
            if (filters.status) {
                const statusText = {
                    'pending': 'Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©',
                    'done': 'Ù…ÙƒØªÙ…Ù„Ø©',
                    'canceled': 'Ù…Ù„ØºÙŠØ©'
                };
                filtersHTML += `<span class="filter-item">Ø§Ù„Ø­Ø§Ù„Ø©: ${statusText[filters.status] || filters.status}</span>`;
            }
            
            if (filters.repId) {
                const rep = repsData.find(r => r.id === filters.repId);
                filtersHTML += `<span class="filter-item">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${rep ? rep.name : filters.repId}</span>`;
            }
            
            if (filters.techId) {
                const tech = techniciansData.find(t => t.id === filters.techId);
                filtersHTML += `<span class="filter-item">Ø§Ù„ÙÙ†ÙŠ: ${tech ? tech.name : filters.techId}</span>`;
            }
            
            if (filters.dateFrom) {
                filtersHTML += `<span class="filter-item">Ù…Ù†: ${filters.dateFrom}</span>`;
            }
            
            if (filters.dateTo) {
                filtersHTML += `<span class="filter-item">Ø¥Ù„Ù‰: ${filters.dateTo}</span>`;
            }
            
            if (!filtersHTML) {
                filtersHTML = '<span class="filter-item">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>';
            }
            
            container.innerHTML = filtersHTML;
        }

        // Display jobs table
        function displayJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            tbody.innerHTML = '';
            
            jobsData.forEach((job, index) => {
                // Extract parts and reps info
                let partsHTML = '';
                let totalPartCost = 0;
                
                if (job.parts && Array.isArray(job.parts) && job.parts.length > 0) {
                    partsHTML = '<ul class="parts-list">';
                    job.parts.forEach(part => {
                        partsHTML += `
                            <li>
                                <span class="part-name">${part.partName || '-'}</span>
                                <br><span class="part-rep">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${part.repName || '-'}</span>
                                <br><span class="part-cost">${(part.partCost || 0).toFixed(2)} Ø±ÙŠØ§Ù„</span>
                            </li>
                        `;
                        totalPartCost += Number(part.partCost) || 0;
                    });
                    partsHTML += '</ul>';
                } else if (job.partName) {
                    partsHTML = `
                        <ul class="parts-list">
                            <li>
                                <span class="part-name">${job.partName}</span>
                                <br><span class="part-rep">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${job.repName || '-'}</span>
                                <br><span class="part-cost">${(job.partCost || 0).toFixed(2)} Ø±ÙŠØ§Ù„</span>
                            </li>
                        </ul>
                    `;
                    totalPartCost = Number(job.partCost) || 0;
                } else {
                    partsHTML = '<span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹</span>';
                    totalPartCost = job.totalPartCost || 0;
                }
                
                // Format date
                let visitDate = '-';
                if (job.visitDate) {
                    try {
                        if (job.visitDate.seconds) {
                            visitDate = new Date(job.visitDate.seconds * 1000).toLocaleDateString('ar-SA');
                        } else {
                            visitDate = new Date(job.visitDate).toLocaleDateString('ar-SA');
                        }
                    } catch (e) {
                        visitDate = '-';
                    }
                }
                
                // Device info
                const deviceInfo = job.deviceModel ? 
                    `${getDeviceTypeText(job.deviceType) || ''} ${job.deviceModel}`.trim() : '-';
                
                // Status
                const statusClass = `status-${job.status || 'pending'}`;
                const statusText = getStatusText(job.status);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${visitDate}</td>
                    <td>
                        <strong>${job.customerName || '-'}</strong>
                        ${job.customerPhone ? `<br><small>${job.customerPhone}</small>` : ''}
                    </td>
                    <td>${deviceInfo}</td>
                    <td>${partsHTML}</td>
                    <td>${job.techName || '-'}</td>
                    <td>${totalPartCost.toFixed(2)} Ø±ÙŠØ§Ù„</td>
                    <td>${(job.amountCharged || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                    <td>${(job.profit || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                    <td>${(job.techCommission || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                    <td>${(job.shopProfit || 0).toFixed(2)} Ø±ÙŠØ§Ù„</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Display summary
        function displaySummary() {
            let totalPartCost = 0;
            let totalRevenue = 0;
            let totalProfit = 0;
            let totalTechCommission = 0;
            let totalShopProfit = 0;
            
            jobsData.forEach(job => {
                // Calculate total part cost
                if (job.parts && Array.isArray(job.parts) && job.parts.length > 0) {
                    totalPartCost += job.parts.reduce((sum, p) => sum + (Number(p.partCost) || 0), 0);
                } else if (job.partCost) {
                    totalPartCost += Number(job.partCost) || 0;
                } else if (job.totalPartCost) {
                    totalPartCost += Number(job.totalPartCost) || 0;
                }
                
                totalRevenue += Number(job.amountCharged) || 0;
                totalProfit += Number(job.profit) || 0;
                totalTechCommission += Number(job.techCommission) || 0;
                totalShopProfit += Number(job.shopProfit) || 0;
            });
            
            document.getElementById('totalJobs').textContent = jobsData.length;
            document.getElementById('totalPartCost').textContent = totalPartCost.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalTechCommission').textContent = totalTechCommission.toFixed(2) + ' Ø±ÙŠØ§Ù„';
            document.getElementById('totalShopProfit').textContent = totalShopProfit.toFixed(2) + ' Ø±ÙŠØ§Ù„';
        }

        // Helper functions
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø©',
                'done': 'Ù…ÙƒØªÙ…Ù„Ø©',
                'canceled': 'Ù…Ù„ØºÙŠØ©'
            };
            return statusMap[status] || status || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }

        function getDeviceTypeText(deviceType) {
            const deviceTypeMap = {
                'mobile': 'Ø¬ÙˆØ§Ù„',
                'tablet': 'ØªØ§Ø¨Ù„Øª',
                'laptop': 'Ù„Ø§Ø¨ØªÙˆØ¨',
                'other': 'Ø£Ø®Ø±Ù‰'
            };
            return deviceTypeMap[deviceType] || deviceType || '';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + message;
        }
    </script>
</body>
</html>

