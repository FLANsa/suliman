<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† â€” ÙŠØ§Ø³Ø± Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</title>

  <!-- Ù†ÙØ³ Ø§Ù„Ø®Ø·/Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #f8f9fa; padding-top: 70px; }
    .navbar { 
      background-color: #2c3e50; 
      position: fixed; 
      top: 0; 
      width: 100%; 
      z-index: 1030; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .navbar-brand, .nav-link { color: white !important; }
    .card { box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .table thead.table-dark th { vertical-align: middle; }
    
    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ */
    .pagination-nav .btn-group .btn {
      border-radius: 0 !important;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .pagination-nav .btn-group .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .pagination-nav .btn-group .btn:first-child {
      border-top-left-radius: 8px !important;
      border-bottom-left-radius: 8px !important;
    }
    
    .pagination-nav .btn-group .btn:last-child {
      border-top-right-radius: 8px !important;
      border-bottom-right-radius: 8px !important;
    }
    
    .pagination-nav .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
      box-shadow: 0 2px 4px rgba(0,123,255,0.3);
    }
  </style>
</head>
<body>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <span class="navbar-brand">ÙŠØ§Ø³Ø± Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</span>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <!-- Navigation will be populated by navigation.js -->
        </ul>
      </div>
    </div>
  </nav>

<div class="container mt-4">
  <!-- Simple Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-3">
        <i class="fas fa-search text-primary"></i> Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
      </h2>
    </div>
  </div>

  <!-- Simple Search Form -->
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <!-- ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·: Ù„Ø§ Ø¥Ø±Ø³Ø§Ù„ Ù„Ø®Ø§Ø¯Ù… -->
          <form id="searchForm" action="#" onsubmit="handleSearch(event)">
            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <label for="search_term" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«</label>
                  <input type="text" class="form-control form-control-lg arabic-number-field" id="search_term" name="search_term"
                         placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠØŒ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ù„Ù…Ø§Ø±ÙƒØ©ØŒ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„...">
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="search_type" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø­Ø«</label>
                  <select class="form-select form-select-lg" id="search_type" name="search_type">
                    <option value="all">Ø§Ù„ÙƒÙ„</option>
                    <option value="phones">Ø§Ù„Ù‡ÙˆØ§ØªÙ</option>
                    <option value="accessories">Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-primary btn-lg px-4">
                <i class="fas fa-search"></i> Ø¨Ø­Ø«
              </button>
              <button type="button" class="btn btn-secondary btn-lg px-4 ms-2" onclick="loadAllData()">
                <i class="fas fa-list"></i> Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Results -->
  <div id="results_wrap" class="row mt-4 d-none">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-list"></i>
            Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (<span id="results_count">0</span>)
          </h5>
        </div>
        <div class="card-body" id="results_body">
          <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Ù…ÙƒØªØ¨Ø§Øª JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase Integration -->
<script type="module" src="js/firebase-config-cdn.js"></script>
<script type="module" src="js/firebase-database-cdn.js"></script>
<script type="module" src="js/firebase-storage-manager.js"></script>

<!-- Firebase Search Integration -->
<script>
  // ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
  let allPhones = [];
  let allAccessories = [];
  let allSales = [];
  
  // ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙØ­Ø§Øª =====
  const ITEMS_PER_PAGE = 20;
  let currentPage = 1;
  let totalPages = 1;
  let currentSearchResults = { phones: [], accessories: [] };

  // ===== Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© =====
  function convertArabicToEnglishNumbers(str) {
    if (!str) return '';
    const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    return str.toString().replace(/[Ù -Ù©]/g, m => map[m] ?? m);
  }
  
  function parseArabicNumber(value) {
    if (!value || value.trim() === '') return 0;
    const converted = convertArabicToEnglishNumbers(value.toString());
    const num = parseFloat(converted);
    return isNaN(num) ? 0 : num;
  }
  
  function setupArabicNumberSupport() {
    document.querySelectorAll('.arabic-number-field').forEach(field => {
      field.addEventListener('input', function() {
        const pos = this.selectionStart;
        const cv = convertArabicToEnglishNumbers(this.value);
        if (cv !== this.value) {
          this.value = cv;
          this.setSelectionRange(pos, pos);
        }
      });
    });
  }

  // ===== Ø§Ù„Ø£Ø¯ÙˆØ§Øª =====
  const fmtMoney = n => (Number(n)||0).toFixed(2);
  function includesAny(str, arr) {
    const s = (str || '').toString().toLowerCase();
    return arr.some(x => s.includes((x||'').toString().toLowerCase()));
  }

  // ===== ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© =====
  function convertArabicToEnglishNumbers(str) {
    if (!str) return '';
    const map = {
      'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
      'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9'
    };
    return str.toString().replace(/[Ù -Ù©]/g, m => map[m] || m);
  }

  // ===== ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ù„Ù‰ Ø¹Ø±Ø¨ÙŠØ© =====
  function convertEnglishToArabicNumbers(str) {
    if (!str) return '';
    const map = {
      '0': 'Ù ', '1': 'Ù¡', '2': 'Ù¢', '3': 'Ù£', '4': 'Ù¤',
      '5': 'Ù¥', '6': 'Ù¦', '7': 'Ù§', '8': 'Ù¨', '9': 'Ù©'
    };
    return str.toString().replace(/[0-9]/g, m => map[m] || m);
  }

  // ===== Ù‡Ù„ Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¨Ø§Ø¹ØŸ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ØµÙØ­Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø¹ Ø´ÙˆÙŠØ© Ù…Ø±ÙˆÙ†Ø© ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„) =====
  function isPhoneSold(phoneId) {
    if (!phoneId) return false;
    if (!allSales || allSales.length === 0) return false;

    // Ø§Ø³ØªØ¨Ø¹Ø¯Ù†Ø§ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
    const effectiveSales = allSales.filter(s => s && s.returned !== true && s.status !== 'Ù…Ø³ØªØ±Ø¬Ø¹Ø©');

    // Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‡Ø§ØªÙ Ø¶Ù…Ù† items ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù
    return effectiveSales.some(sale =>
      Array.isArray(sale.items) &&
      sale.items.some(item => {
        const isPhoneType =
          item.type === 'phone' ||
          item.product_type === 'phone' ||
          item.type === 'Ù‡Ø§ØªÙ';

        const candidateIds = [
          item.id,
          item.phone_id,
          item.barcode,
          item.phone_number,
          item.device_number,
          item.serial_number
        ].filter(Boolean).map(String);

        return isPhoneType && candidateIds.includes(String(phoneId));
      })
    );
  }


  // (ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†Ø§ØµØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø­Ø« ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø«)

  // ===== Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
  async function handleSearch(e){
    e.preventDefault();
    const term = (document.getElementById('search_term').value || '').trim();
    const type = document.getElementById('search_type').value || 'all';
    const statusFilter = 'all';

    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†:', term, 'Ù†ÙˆØ¹:', type, 'Ø­Ø§Ù„Ø©:', statusFilter);

    if (!term) {
      showAlert('warning', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«');
      return;
    }

    try {
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø£Ùˆ localStorage
      if (window.storage && window.storage.isFirebaseAvailable) {
        console.log('ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ù„Ù„Ø¨Ø­Ø«...');
        allPhones = await window.storage.getPhones();
        allAccessories = await window.storage.getAccessories();
        allSales = await window.storage.getSales();
        console.log('ğŸ“± Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', allPhones);
        console.log('ğŸ“¦ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', allAccessories);
        console.log('ğŸ§¾ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', allSales);
      } else {
        console.log('ğŸ’¾ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage...');
        allPhones = JSON.parse(localStorage.getItem('phones') || '[]');
        allAccessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        allSales = JSON.parse(localStorage.getItem('sales') || '[]');
        console.log('ğŸ“± Ø§Ù„Ù‡ÙˆØ§ØªÙ Ù…Ù† localStorage:', allPhones);
        console.log('ğŸ“¦ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† localStorage:', allAccessories);
        console.log('ğŸ§¾ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† localStorage:', allSales);
      }

      // Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø­ØªØ§Ø¬ Set Ù„Ø£Ù†Ù†Ø§ Ø³Ù†Ø³ØªØ®Ø¯Ù… isPhoneSold Ù…Ø¨Ø§Ø´Ø±Ø©

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„Ø¨Ø­Ø«
      const englishTerm = convertArabicToEnglishNumbers(term);
      const arabicTerm = convertEnglishToArabicNumbers(term);
      
      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù†Ø³Ø®ØªÙŠÙ† (Ø¹Ø±Ø¨ÙŠØ© ÙˆØ¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)
      const searchTerms = [term.toLowerCase(), englishTerm.toLowerCase(), arabicTerm.toLowerCase()];
      const uniqueTerms = [...new Set(searchTerms)]; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
      
      console.log('ğŸ”¤ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§:', uniqueTerms);

      let phones = [];
      let accessories = [];

      if (type === 'all' || type === 'phones') {
        phones = allPhones.filter(p => {
          
          // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Øµ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
          // Ø¥Ø¶Ø§ÙØ© serial_number Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
          const searchText = `${p.phone_number || ''} ${p.serial_number || ''} ${p.manufacturer || p.brand || ''} ${p.model || ''} ${p.condition || p.phone_type || ''}`.toLowerCase();
          const englishSearchText = convertArabicToEnglishNumbers(searchText);
          const arabicSearchText = convertEnglishToArabicNumbers(searchText);
          
          console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ:', p.phone_number, 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ:', p.serial_number, 'Ø§Ù„Ù†Øµ:', searchText, 'Ø§Ù„Ø­Ø§Ù„Ø©:', p.status || 'available');
          
          // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® (Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŒ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
          return uniqueTerms.some(term => 
            searchText.includes(term) || 
            englishSearchText.includes(term) || 
            arabicSearchText.includes(term)
          );
        });
      }

      if (type === 'all' || type === 'accessories') {
        accessories = allAccessories.filter(a => {
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ùˆ serial_number Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª
          const searchText = `${a.name || ''} ${a.arabic_name || ''} ${a.barcode || ''} ${a.barcode_id || ''} ${a.serial_number || ''} ${a.category || ''}`.toLowerCase();
          const englishSearchText = convertArabicToEnglishNumbers(searchText);
          const arabicSearchText = convertEnglishToArabicNumbers(searchText);
          
          console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±:', a.name || a.arabic_name, 'Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', a.barcode, 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ:', a.serial_number, 'Ø§Ù„Ù†Øµ:', searchText);
          
          // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø® (Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŒ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
          return uniqueTerms.some(term => 
            searchText.includes(term) || 
            englishSearchText.includes(term) || 
            arabicSearchText.includes(term)
          );
        });
      }

      console.log('ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:', { phones: phones.length, accessories: accessories.length });
      console.log('ğŸ“± Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:', phones);
      console.log('ğŸ“¦ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:', accessories);
      
      // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      currentSearchResults = { phones, accessories };
      currentPage = 1;
      
      renderResults(phones, accessories);

    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
      showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
  }

  // ===== Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØµÙØ­Ø§Øª =====
  function renderResults(phones, accessories){
    const wrap = document.getElementById('results_wrap');
    const body = document.getElementById('results_body');
    const countEl = document.getElementById('results_count');

    const total = (phones?.length || 0) + (accessories?.length || 0);
    countEl.textContent = total;

    wrap.classList.remove('d-none');
    if (total === 0){
      body.innerHTML = `
        <div class="text-center py-4">
          <i class="fas fa-search fa-3x text-muted mb-3"></i>
          <h4 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h4>
          <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«</p>
        </div>`;
      return;
    }

    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª
    totalPages = Math.ceil(total / ITEMS_PER_PAGE);
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;
    
    // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const currentPhones = phones.slice(startIndex, endIndex);
    const currentAccessories = accessories.slice(startIndex, endIndex);

    let html = '';

    // Phones - Sort by status: available first, then sold
    if (phones && phones.length){
      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª: Ø§Ù„Ù…ØªØ§Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©
      const sortedPhones = phones.sort((a, b) => {
        const aId = a.id || a.phone_number || a.device_number || a.serial_number;
        const bId = b.id || b.phone_number || b.device_number || b.serial_number;
        
        const aSold = aId && isPhoneSold(String(aId));
        const bSold = bId && isPhoneSold(String(bId));
        
        // Ø§Ù„Ù…ØªØ§Ø­Ø© ØªØ£ØªÙŠ Ø£ÙˆÙ„Ø§Ù‹ (false ÙŠØ£ØªÙŠ Ù‚Ø¨Ù„ true)
        if (aSold !== bSold) {
          return aSold ? 1 : -1;
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†ÙØ³ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²
        return (a.phone_number || '').localeCompare(b.phone_number || '');
      });
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬ÙˆØ§Ù„Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const phonesForCurrentPage = sortedPhones.slice(startIndex, endIndex);
      
      html += `
        <div class="mb-4">
          <h6 class="text-primary mb-3">
            <i class="fas fa-mobile-alt"></i> Ø§Ù„Ù‡ÙˆØ§ØªÙ (${phones.length}) - Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${totalPages}
          </h6>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯/Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                  <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</th>
                  <th>Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©</th>
                  <th>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                  <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                ${phonesForCurrentPage.map(p => `
                  <tr>
                    <td><strong>${p.phone_number || p.device_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong></td>
                    <td><span class="text-info">${p.serial_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></td>
                    <td>${p.manufacturer || p.brand || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${p.model || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>
                      ${
                        (() => {
                          const pid = p.id || p.phone_number || p.device_number || p.serial_number;
                          return (pid && isPhoneSold(String(pid)))
                            ? '<span class="badge bg-danger">Ù…Ø¨Ø§Ø¹</span>'
                            : '<span class="badge bg-success">Ù…ØªØ§Ø­</span>';
                        })()
                      }
                    </td>
                    <td><span class="text-success">${fmtMoney(p.purchase_price || 0)} Ø±ÙŠØ§Ù„</span></td>
                    <td><span class="text-primary">${fmtMoney(p.selling_price || p.price || 0)} Ø±ÙŠØ§Ù„</span></td>
                    <td>
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewPhoneDetails('${p.phone_number || p.id}')" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                          <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editPhone('${p.phone_number || p.id}')" title="ØªØ¹Ø¯ÙŠÙ„">
                          <i class="fas fa-edit"></i>
                        </button>
                        <!-- âœ… Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
                        <button type="button" class="btn btn-sm btn-outline-dark"
                                onclick="goPrintBarcode('${p.phone_number || p.device_number || p.serial_number || p.id}')"
                                title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
                          <i class="fas fa-barcode"></i>
                        </button>
                        <!-- âœ… Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø² -->
                        <button type="button" class="btn btn-sm btn-outline-danger"
                                onclick="deletePhone('${p.id || p.phone_number}')"
                                title="Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø²">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    // Accessories
    if (accessories && accessories.length){
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const accessoriesForCurrentPage = accessories.slice(startIndex, endIndex);
      
      html += `
        <div class="mb-4">
          <h6 class="text-success mb-3">
            <i class="fas fa-box"></i> Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª (${accessories.length}) - Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${totalPages}
          </h6>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                  <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</th>
                  <th>Ø§Ù„ÙØ¦Ø©</th>
                  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                  <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                  <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                ${accessoriesForCurrentPage.map(a => `
                  <tr>
                    <td><strong>${a.arabic_name || a.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong></td>
                    <td><span class="text-info">${a.barcode || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></td>
                    <td><span class="text-info">${a.serial_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></td>
                    <td><span class="badge bg-primary">${a.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span></td>
                    <td><span class="badge bg-success">${a.quantity_in_stock || a.quantity || 0}</span></td>
                    <td><span class="text-success">${fmtMoney(a.purchase_price || 0)} Ø±ÙŠØ§Ù„</span></td>
                    <td><span class="text-primary">${fmtMoney(a.selling_price || 0)} Ø±ÙŠØ§Ù„</span></td>
                    <td>
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewAccessoryDetails('${a.id}')" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                          <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editAccessory('${a.id}')" title="ØªØ¹Ø¯ÙŠÙ„">
                          <i class="fas fa-edit"></i>
                        </button>
                        ${a.barcode ? `<button type="button" class="btn btn-sm btn-outline-success" onclick="goPrintAccessoryBarcode('${a.barcode}')" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
                          <i class="fas fa-barcode"></i>
                        </button>` : ''}
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteAccessory('${a.id}')" title="Ø­Ø°Ù">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>`;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
    if (totalPages > 1) {
      html += generatePaginationButtons();
    }

    wrap.classList.remove('d-none');
    body.innerHTML = html;
  }

  // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙØ­Ø§Øª =====
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
  function generatePaginationButtons() {
    let buttons = '';
    
    // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    if (currentPage > 1) {
      buttons += `<button class="btn btn-outline-primary btn-sm" onclick="goToPage(${currentPage - 1})">
        <i class="fas fa-chevron-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
      </button>`;
    }
    
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
      buttons += `<button class="btn btn-outline-secondary btn-sm" onclick="goToPage(1)">1</button>`;
      if (startPage > 2) {
        buttons += `<span class="mx-2 text-muted">...</span>`;
      }
    }
    
    for (let i = startPage; i <= endPage; i++) {
      const isActive = i === currentPage ? 'btn-primary' : 'btn-outline-secondary';
      buttons += `<button class="btn ${isActive} btn-sm" onclick="goToPage(${i})">${i}</button>`;
    }
    
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        buttons += `<span class="mx-2 text-muted">...</span>`;
      }
      buttons += `<button class="btn btn-outline-secondary btn-sm" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
    if (currentPage < totalPages) {
      buttons += `<button class="btn btn-outline-primary btn-sm" onclick="goToPage(${currentPage + 1})">
        Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-chevron-left"></i>
      </button>`;
    }
    
    return `
      <div class="d-flex justify-content-center mt-4 mb-4">
        <nav aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª" class="pagination-nav">
          <div class="btn-group shadow-sm" role="group" style="border-radius: 8px; overflow: hidden;">
            ${buttons}
          </div>
        </nav>
      </div>
    `;
  }
  
  // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ù…Ø­Ø¯Ø¯Ø©
  function goToPage(page) {
    if (page < 1 || page > totalPages || page === currentPage) return;
    
    currentPage = page;
    renderResults(currentSearchResults.phones, currentSearchResults.accessories);
    
    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    document.getElementById('results_wrap').scrollIntoView({ behavior: 'smooth' });
  }

  // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª =====
  
  // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ
  function viewPhoneDetails(phoneNumber) {
    const phone = allPhones.find(p => p.phone_number === phoneNumber || p.id === phoneNumber);
    if (phone) {
      const details = `
Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²: ${phone.phone_number || phone.device_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©: ${phone.manufacturer || phone.brand || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ${phone.model || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø­Ø§Ù„Ø©: ${phone.condition === 'new' || phone.phone_type === 'new' ? 'Ø¬Ø¯ÙŠØ¯' : 'Ù…Ø³ØªØ¹Ù…Ù„'}
Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: ${fmtMoney(phone.purchase_price || 0)} Ø±ÙŠØ§Ù„
Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹: ${fmtMoney(phone.selling_price || phone.price || 0)} Ø±ÙŠØ§Ù„
Ø§Ù„Ø±Ø¨Ø­: ${fmtMoney((phone.selling_price || phone.price || 0) - (phone.purchase_price || 0))} Ø±ÙŠØ§Ù„
Ø§Ù„Ø°Ø§ÙƒØ±Ø©: ${phone.phone_memory || phone.memory || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©: ${phone.battery_level || phone.age || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ù„ÙˆÙ†: ${phone.phone_color || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ: ${phone.serial_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø¶Ù…Ø§Ù†: ${phone.warranty || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Ø´Ù‡Ø±
      `;
      alert(details);
    }
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§ØªÙ
  function editPhone(phoneNumber) {
    const phone = allPhones.find(p => p.phone_number === phoneNumber || p.id === phoneNumber);
    if (phone) {
      // ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®ØµØµØ©
      window.location.href = `edit_phone.html?edit=${phoneNumber}`;
    }
  }

  // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±
  function viewAccessoryDetails(accessoryId) {
    const accessory = allAccessories.find(a => a.id === accessoryId);
    if (accessory) {
      const details = `
Ø§Ù„Ø§Ø³Ù…: ${accessory.arabic_name || accessory.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„ÙØ¦Ø©: ${accessory.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„ÙƒÙ…ÙŠØ©: ${accessory.quantity_in_stock || accessory.quantity || 0}
Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: ${fmtMoney(accessory.purchase_price || 0)} Ø±ÙŠØ§Ù„
Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹: ${fmtMoney(accessory.selling_price || 0)} Ø±ÙŠØ§Ù„
Ø§Ù„Ù…ÙˆØ±Ø¯: ${accessory.supplier || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„ÙˆØµÙ: ${accessory.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}
      `;
      alert(details);
    }
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±
  function editAccessory(accessoryId) {
    window.location.href = `edit_accessory.html?id=${accessoryId}`;
  }

  // Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±
  async function deleteAccessory(accessoryId) {
    const accessory = allAccessories.find(a => a.id === accessoryId);
    if (!accessory) return;

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${accessory.arabic_name || accessory.name}"ØŸ`)) return;

    try {
      if (window.storage && window.storage.isFirebaseAvailable) {
        const success = await window.storage.deleteAccessory(accessoryId);
        if (success) {
          showAlert('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø± Ø¨Ù†Ø¬Ø§Ø­');
          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
          document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        } else {
          showAlert('danger', 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
        }
      } else {
        showAlert('warning', 'Firebase ØºÙŠØ± Ù…ØªØ§Ø­. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±.');
      }
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±:', error);
      showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±');
    }
  }

  // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  function checkLogin() {
    const currentUser = localStorage.getItem('current_user');
    if (!currentUser) {
      alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      window.location.href = 'login.html';
      return false;
    }
    return true;
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  function logout() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
      localStorage.removeItem('current_user');
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
      window.location.href = 'index.html';
    }
  }

  // ===== ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© =====
  async function loadAllData() {
    try {
      if (window.storage && window.storage.isFirebaseAvailable) {
        console.log('ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...');
        allPhones = await window.storage.getPhones();
        allAccessories = await window.storage.getAccessories();
        allSales = await window.storage.getSales(); // âœ… Ù…Ù‡Ù…
        console.log('ğŸ“± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‡ÙˆØ§ØªÙ:', allPhones);
        console.log('ğŸ“¦ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª:', allAccessories);
        console.log('ğŸ§¾ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', allSales);
      } else {
        console.log('ğŸ’¾ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage...');
        allPhones = JSON.parse(localStorage.getItem('phones') || '[]');
        allAccessories = JSON.parse(localStorage.getItem('accessories') || '[]');
        allSales = JSON.parse(localStorage.getItem('sales') || '[]'); // âœ… Ù…Ù‡Ù…
        console.log('ğŸ“± Ø§Ù„Ù‡ÙˆØ§ØªÙ Ù…Ù† localStorage:', allPhones);
        console.log('ğŸ“¦ Ø§Ù„Ø£ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù…Ù† localStorage:', allAccessories);
        console.log('ğŸ§¾ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† localStorage:', allSales);
      }

      // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      currentSearchResults = { phones: allPhones, accessories: allAccessories };
      currentPage = 1;
      
      // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù€ isPhoneSold Ø¨ØªÙ‚Ø±Ø£ Ù…Ù† allSales)
      renderResults(allPhones, allAccessories);
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  }

  // Check user role and update navigation
  function updateNavigationForUser() {
    const currentUser = localStorage.getItem('current_user');
    if (currentUser) {
      try {
        const userData = JSON.parse(currentUser);
        const navbar = document.querySelector('.navbar-nav.me-auto');
        
        if (userData.role === 'user') {
          // Show simplified navigation for limited users
          navbar.innerHTML = `
            <li class="nav-item"><a class="nav-link" href="limited_dashboard.html"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
          `;
        }
        // Admin users keep the full navigation (default)
      } catch (error) {
        console.error('Error parsing user data:', error);
      }
    }
  }

  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', async function() {
    // Update navigation based on user role
    updateNavigationForUser();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    setupArabicNumberSupport();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
    if (!checkLogin()) return;

    // Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Firebase
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    if (window.storage && window.storage.isFirebaseAvailable) {
      console.log('âœ… Firebase Ù…ØªØ§Ø­ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«');
    } else {
      console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage');
    }
    
    // Ù„Ø§ ØªÙØ¸Ù‡Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ â€” ØªÙØ¹Ø±Ø¶ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„"
    
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¥Ø°Ø§ ØªÙ… ØªÙ…Ø±ÙŠØ±Ù‡ ÙÙŠ URL
    const urlParams = new URLSearchParams(window.location.search);
    const barcode = urlParams.get('barcode');
    const type = urlParams.get('type');
    
    if (barcode) {
      console.log('ğŸ” Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', barcode, 'Ø§Ù„Ù†ÙˆØ¹:', type);
      document.getElementById('search_term').value = barcode;
      
      if (type) {
        document.getElementById('search_type').value = type === 'accessory' ? 'accessories' : 'phones';
      }
      
      // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      setTimeout(() => {
        handleSearch({ preventDefault: () => {} });
      }, 500);
    }
  });

  // ===== Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ =====
  function goPrintBarcode(rawCode) {
    const code = String(rawCode || '').trim();
    if (!code) { 
      showAlert('warning', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¨Ø§Ø±ÙƒÙˆØ¯ ØµØ§Ù„Ø­ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²'); 
      return; 
    }
    // âœ… Ù†ÙˆØ¬Ù‘Ù‡ Ø¨Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    window.location.href = `print_barcode.html?edit=${encodeURIComponent(code)}`;
  }

  // ===== Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø± =====
  function goPrintAccessoryBarcode(rawCode) {
    const code = String(rawCode || '').trim();
    if (!code) { 
      showAlert('warning', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ø¨Ø§Ø±ÙƒÙˆØ¯ ØµØ§Ù„Ø­ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±'); 
      return; 
    }
    // ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª
    window.location.href = `print_accessory_barcode.html?barcode=${encodeURIComponent(code)}`;
  }

  // ===== Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø² =====
  async function deletePhone(phoneId) {
    console.log('ğŸ—‘ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø²:', phoneId);
    
    if (!phoneId) {
      console.error('âŒ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± ØµØ§Ù„Ø­');
      showAlert('danger', 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± ØµØ§Ù„Ø­');
      return;
    }

    // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡
    const phone = allPhones.find(p => p.id === phoneId || p.phone_number === phoneId);
    if (!phone) {
      console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²:', phoneId);
      showAlert('danger', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨');
      return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø¨Ø§Ø¹
    const phoneIdentifier = phone.id || phone.phone_number || phone.device_number || phone.serial_number;
    if (phoneIdentifier && isPhoneSold(String(phoneIdentifier))) {
      showAlert('warning', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¬Ù‡Ø§Ø² ØªÙ… Ø¨ÙŠØ¹Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
      return;
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ

Ø§Ù„Ø¬Ù‡Ø§Ø²: ${phone.manufacturer || phone.brand || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} ${phone.model || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${phone.phone_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ: ${phone.serial_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}

âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`;

    if (!confirm(confirmMessage)) {
      console.log('âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù');
      return;
    }

    try {
      console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù...');
      
      if (window.storage && window.storage.isFirebaseAvailable) {
        // Ø­Ø°Ù Ù…Ù† Firebase
        console.log('ğŸ”¥ Ø­Ø°Ù Ù…Ù† Firebase...');
        await window.storage.deletePhone(phoneId);
        console.log('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Firebase Ø¨Ù†Ø¬Ø§Ø­');
      } else {
        // Ø­Ø°Ù Ù…Ù† localStorage
        console.log('ğŸ’¾ Ø­Ø°Ù Ù…Ù† localStorage...');
        const phones = JSON.parse(localStorage.getItem('phones') || '[]');
        const updatedPhones = phones.filter(p => p.id !== phoneId && p.phone_number !== phoneId);
        localStorage.setItem('phones', JSON.stringify(updatedPhones));
        console.log('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† localStorage Ø¨Ù†Ø¬Ø§Ø­');
      }

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      await loadAllData();
      
      showAlert('success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­');
      console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­');
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø²:', error);
      showAlert('danger', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø². Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
  }
</script>

<!-- Navigation Script -->
<script src="js/navigation.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    initNavigation('search');
  });
</script>
</body>
</html>
